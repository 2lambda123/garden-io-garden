"use strict";
/*
 * Copyright (C) 2018 Garden Technologies, Inc. <info@garden.io>
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const ansiEscapes = require("ansi-escapes");
const cliCursor = require("cli-cursor");
const elegantSpinner = require("elegant-spinner");
const wrapAnsi = require("wrap-ansi");
const chalk_1 = require("chalk");
const renderers_1 = require("../renderers");
const util_1 = require("../util");
const base_1 = require("./base");
const INTERVAL_MS = 60;
const THROTTLE_MS = 600;
const spinnerStyle = chalk_1.default.cyan;
class FancyTerminalWriter extends base_1.Writer {
    constructor(config = {}) {
        super(config);
        this.intervalID = null;
        this.spinners = {}; // Each entry has it's own spinner
        this.prevOutput = [];
        this.lastInterceptAt = null;
        this.updatePending = false;
    }
    initStream(logger) {
        // Create custom stream that calls write method with the 'noIntercept' option.
        const stream = Object.assign({}, process.stdout, { write: (str, enc, cb) => process.stdout.write(str, enc, cb, { noIntercept: true }) });
        const onIntercept = msg => logger.info({ msg, fromStdStream: true });
        const restoreStreamFns = [
            util_1.interceptStream(process.stdout, onIntercept),
            util_1.interceptStream(process.stderr, onIntercept),
        ];
        stream.cleanUp = () => {
            cliCursor.show(this.stream);
            restoreStreamFns.forEach(restoreStream => restoreStream());
        };
        return stream;
    }
    spin(entries, totalLines) {
        entries.forEach(e => {
            let out = "";
            const [x, y] = e.spinnerCoords;
            const termX = x === 0 ? x : x + 1;
            const termY = -(totalLines - y - 1);
            out += ansiEscapes.cursorSavePosition;
            out += ansiEscapes.cursorTo(0); // Ensure cursor is to the left
            out += ansiEscapes.cursorMove(termX, termY);
            out += spinnerStyle(this.tickSpinner(e.key));
            out += ansiEscapes.cursorRestorePosition;
            this.stream.write(out);
        });
    }
    startLoop(entries, totalLines) {
        this.stopLoop();
        this.intervalID = setInterval(() => this.spin(entries, totalLines), INTERVAL_MS);
    }
    stopLoop() {
        if (this.intervalID) {
            clearInterval(this.intervalID);
            this.intervalID = null;
        }
    }
    tickSpinner(key) {
        if (!this.spinners[key]) {
            this.spinners[key] = elegantSpinner();
        }
        return this.spinners[key]();
    }
    write(output, nextEntry) {
        cliCursor.hide(this.stream);
        const lineNumber = output.length >= this.prevOutput.length ? nextEntry.lineNumber : 0;
        const nLinesToErase = this.prevOutput.length - lineNumber;
        this.stream.write(ansiEscapes.eraseLines(nLinesToErase) + output.slice(lineNumber).join("\n"));
    }
    handleGraphChange(logEntry, logger, didWrite = false) {
        this.updatePending = false;
        // Suspend processing and write immediately if a lot of data is being intercepted, e.g. when user is typing in input
        if (logEntry.fromStdStream() && !didWrite) {
            const now = Date.now();
            const throttleProcessing = this.lastInterceptAt && (now - this.lastInterceptAt) < THROTTLE_MS;
            this.lastInterceptAt = now;
            if (throttleProcessing) {
                this.stopLoop();
                this.stream.write(renderers_1.renderMsg(logEntry));
                this.updatePending = true;
                // Resume processing if idle and original update is still pending
                setTimeout(() => {
                    if (this.updatePending) {
                        this.handleGraphChange(logEntry, logger, true);
                    }
                }, THROTTLE_MS);
                return;
            }
        }
        const terminalEntries = this.toTerminalEntries(logger);
        const nextEntry = terminalEntries.find(e => e.key === logEntry.key);
        // Nothing to do, e.g. because entry level is higher than writer level
        if (!nextEntry) {
            return;
        }
        const output = this.render(terminalEntries);
        if (!didWrite) {
            this.write(output, nextEntry);
        }
        const entriesWithspinner = terminalEntries.filter(e => e.spinnerCoords);
        if (entriesWithspinner.length > 0) {
            this.startLoop(entriesWithspinner, output.length);
        }
        else {
            this.stopLoop();
        }
        this.prevOutput = output;
    }
    toTerminalEntries(logger) {
        const level = this.level || logger.level;
        let currentLineNumber = 0;
        return util_1.getChildEntries(logger)
            .filter(entry => util_1.validate(level, entry))
            .reduce((acc, entry) => {
            let spinnerFrame = "";
            let spinnerX;
            let spinnerCoords;
            if (entry.opts.status === "active") {
                spinnerX = renderers_1.leftPad(entry).length;
                spinnerFrame = this.tickSpinner(entry.key);
                spinnerCoords = [spinnerX, currentLineNumber];
            }
            else {
                delete this.spinners[entry.key];
            }
            const text = [entry]
                .map(e => (e.fromStdStream()
                ? renderers_1.renderMsg(e)
                : renderers_1.formatForTerminal(e)))
                .map(str => (spinnerFrame
                ? `${str.slice(0, spinnerX)}${spinnerStyle(spinnerFrame)} ${str.slice(spinnerX)}`
                : str))
                .map(str => wrapAnsi(str, util_1.getTerminalWidth(this.stream), {
                trim: false,
                hard: true,
                wordWrap: false,
            }))
                .pop();
            acc.push({
                key: entry.key,
                lineNumber: currentLineNumber,
                spinnerCoords,
                text,
            });
            currentLineNumber += text.split("\n").length - 1;
            return acc;
        }, []);
    }
    render(terminalEntries) {
        return terminalEntries.map(e => e.text).join("").split("\n");
    }
    onGraphChange(logEntry, logger) {
        if (!this.stream) {
            this.stream = this.initStream(logger);
        }
        this.handleGraphChange(logEntry, logger, false);
    }
    stop() {
        this.stopLoop();
        this.stream && this.stream.cleanUp();
    }
}
exports.FancyTerminalWriter = FancyTerminalWriter;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxvZ2dlci93cml0ZXJzL2ZhbmN5LXRlcm1pbmFsLXdyaXRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7OztHQU1HOztBQUVILDRDQUEyQztBQUMzQyx3Q0FBdUM7QUFDdkMsa0RBQWlEO0FBQ2pELHNDQUFxQztBQUNyQyxpQ0FBeUI7QUFFekIsNENBSXFCO0FBSXJCLGtDQUtnQjtBQUNoQixpQ0FBNkM7QUFFN0MsTUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFBO0FBQ3RCLE1BQU0sV0FBVyxHQUFHLEdBQUcsQ0FBQTtBQUV2QixNQUFNLFlBQVksR0FBRyxlQUFLLENBQUMsSUFBSSxDQUFBO0FBbUIvQixNQUFhLG1CQUFvQixTQUFRLGFBQU07SUFVN0MsWUFBWSxTQUF1QixFQUFFO1FBQ25DLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUNiLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFBO1FBQ3RCLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFBLENBQUMsa0NBQWtDO1FBQ3JELElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFBO1FBQ3BCLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFBO1FBQzNCLElBQUksQ0FBQyxhQUFhLEdBQUcsS0FBSyxDQUFBO0lBQzVCLENBQUM7SUFFTyxVQUFVLENBQUMsTUFBYztRQUMvQiw4RUFBOEU7UUFDOUUsTUFBTSxNQUFNLEdBQUcsa0JBQ1YsT0FBTyxDQUFDLE1BQU0sSUFDakIsS0FBSyxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFPLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBTSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxDQUFDLEdBQzFGLENBQUE7UUFFRCxNQUFNLFdBQVcsR0FBRyxHQUFHLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxH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QUVULEdBQUcsQ0FBQyxJQUFJLENBQUM7Z0JBQ1AsR0FBRyxFQUFFLEtBQUssQ0FBQyxHQUFHO2dCQUNkLFVBQVUsRUFBRSxpQkFBaUI7Z0JBQzdCLGFBQWE7Z0JBQ2IsSUFBSTthQUNMLENBQUMsQ0FBQTtZQUVGLGlCQUFpQixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQTtZQUVoRCxPQUFPLEdBQUcsQ0FBQTtRQUNaLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUNWLENBQUM7SUFFTSxNQUFNLENBQUMsZUFBZ0M7UUFDNUMsT0FBTyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDOUQsQ0FBQztJQUVNLGFBQWEsQ0FBQyxRQUFrQixFQUFFLE1BQWM7UUFDckQsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDaEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1NBQ3RDO1FBRUQsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUE7SUFDakQsQ0FBQztJQUVNLElBQUk7UUFDVCxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUE7UUFDZixJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUE7SUFDdEMsQ0FBQztDQUVGO0FBM01ELGtEQTJNQyIsImZpbGUiOiJsb2dnZXIvd3JpdGVycy9mYW5jeS10ZXJtaW5hbC13cml0ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IChDKSAyMDE4IEdhcmRlbiBUZWNobm9sb2dpZXMsIEluYy4gPGluZm9AZ2FyZGVuLmlvPlxuICpcbiAqIFRoaXMgU291cmNlIENvZGUgRm9ybSBpcyBzdWJqZWN0IHRvIHRoZSB0ZXJtcyBvZiB0aGUgTW96aWxsYSBQdWJsaWNcbiAqIExpY2Vuc2UsIHYuIDIuMC4gSWYgYSBjb3B5IG9mIHRoZSBNUEwgd2FzIG5vdCBkaXN0cmlidXRlZCB3aXRoIHRoaXNcbiAqIGZpbGUsIFlvdSBjYW4gb2J0YWluIG9uZSBhdCBodHRwOi8vbW96aWxsYS5vcmcvTVBMLzIuMC8uXG4gKi9cblxuaW1wb3J0ICogYXMgYW5zaUVzY2FwZXMgZnJvbSBcImFuc2ktZXNjYXBlc1wiXG5pbXBvcnQgKiBhcyBjbGlDdXJzb3IgZnJvbSBcImNsaS1jdXJzb3JcIlxuaW1wb3J0ICogYXMgZWxlZ2FudFNwaW5uZXIgZnJvbSBcImVsZWdhbnQtc3Bpbm5lclwiXG5pbXBvcnQgKiBhcyB3cmFwQW5zaSBmcm9tIFwid3JhcC1hbnNpXCJcbmltcG9ydCBjaGFsayBmcm9tIFwiY2hhbGtcIlxuXG5pbXBvcnQge1xuICBmb3JtYXRGb3JUZXJtaW5hbCxcbiAgbGVmdFBhZCxcbiAgcmVuZGVyTXNnLFxufSBmcm9tIFwiLi4vcmVuZGVyZXJzXCJcbmltcG9ydCB7IExvZ0VudHJ5IH0gZnJvbSBcIi4uL2xvZy1lbnRyeVwiXG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tIFwiLi4vbG9nZ2VyXCJcbmltcG9ydCB7IExvZ0xldmVsIH0gZnJvbSBcIi4uL2xvZy1ub2RlXCJcbmltcG9ydCB7XG4gIGdldENoaWxkRW50cmllcyxcbiAgZ2V0VGVybWluYWxXaWR0aCxcbiAgaW50ZXJjZXB0U3RyZWFtLFxuICB2YWxpZGF0ZSxcbn0gZnJvbSBcIi4uL3V0aWxcIlxuaW1wb3J0IHsgV3JpdGVyLCBXcml0ZXJDb25maWcgfSBmcm9tIFwiLi9iYXNlXCJcblxuY29uc3QgSU5URVJWQUxfTVMgPSA2MFxuY29uc3QgVEhST1RUTEVfTVMgPSA2MDBcblxuY29uc3Qgc3Bpbm5lclN0eWxlID0gY2hhbGsuY3lhblxuXG5leHBvcnQgdHlwZSBDb29yZHMgPSBbbnVtYmVyLCBudW1iZXJdXG5cbmV4cG9ydCBpbnRlcmZhY2UgVGVybWluYWxFbnRyeSB7XG4gIGtleTogc3RyaW5nXG4gIHRleHQ6IHN0cmluZ1xuICBsaW5lTnVtYmVyOiBudW1iZXJcbiAgc3Bpbm5lckNvb3Jkcz86IENvb3Jkc1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRlcm1pbmFsRW50cnlXaXRoU3Bpbm5lciBleHRlbmRzIFRlcm1pbmFsRW50cnkge1xuICBzcGlubmVyQ29vcmRzOiBDb29yZHNcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDdXN0b21TdHJlYW0gZXh0ZW5kcyBOb2RlSlMuV3JpdGVTdHJlYW0ge1xuICBjbGVhblVwOiBGdW5jdGlvblxufVxuXG5leHBvcnQgY2xhc3MgRmFuY3lUZXJtaW5hbFdyaXRlciBleHRlbmRzIFdyaXRlciB7XG4gIHByaXZhdGUgc3Bpbm5lcnM6IHsgW2tleTogc3RyaW5nXTogRnVuY3Rpb24gfVxuICBwcml2YXRlIGludGVydmFsSUQ6IE5vZGVKUy5UaW1lciB8IG51bGxcbiAgcHJpdmF0ZSBzdHJlYW06IEN1c3RvbVN0cmVhbVxuICBwcml2YXRlIHByZXZPdXRwdXQ6IHN0cmluZ1tdXG4gIHByaXZhdGUgbGFzdEludGVyY2VwdEF0OiBudW1iZXIgfCBudWxsXG4gIHByaXZhdGUgdXBkYXRlUGVuZGluZzogYm9vbGVhblxuXG4gIHB1YmxpYyBsZXZlbDogTG9nTGV2ZWxcblxuICBjb25zdHJ1Y3Rvcihjb25maWc6IFdyaXRlckNvbmZpZyA9IHt9KSB7XG4gICAgc3VwZXIoY29uZmlnKVxuICAgIHRoaXMuaW50ZXJ2YWxJRCA9IG51bGxcbiAgICB0aGlzLnNwaW5uZXJzID0ge30gLy8gRWFjaCBlbnRyeSBoYXMgaXQncyBvd24gc3Bpbm5lclxuICAgIHRoaXMucHJldk91dHB1dCA9IFtdXG4gICAgdGhpcy5sYXN0SW50ZXJjZXB0QXQgPSBudWxsXG4gICAgdGhpcy51cGRhdGVQZW5kaW5nID0gZmFsc2VcbiAgfVxuXG4gIHByaXZhdGUgaW5pdFN0cmVhbShsb2dnZXI6IExvZ2dlcik6IEN1c3RvbVN0cmVhbSB7XG4gICAgLy8gQ3JlYXRlIGN1c3RvbSBzdHJlYW0gdGhhdCBjYWxscyB3cml0ZSBtZXRob2Qgd2l0aCB0aGUgJ25vSW50ZXJjZXB0JyBvcHRpb24uXG4gICAgY29uc3Qgc3RyZWFtID0gPEN1c3RvbVN0cmVhbT57XG4gICAgICAuLi5wcm9jZXNzLnN0ZG91dCxcbiAgICAgIHdyaXRlOiAoc3RyLCBlbmMsIGNiKSA9PiAoPGFueT5wcm9jZXNzLnN0ZG91dC53cml0ZSkoc3RyLCBlbmMsIGNiLCB7IG5vSW50ZXJjZXB0OiB0cnVlIH0pLFxuICAgIH1cblxuICAgIGNvbnN0IG9uSW50ZXJjZXB0ID0gbXNnID0+IGxvZ2dlci5pbmZvKHsgbXNnLCBmcm9tU3RkU3RyZWFtOiB0cnVlIH0pXG5cbiAgICBjb25zdCByZXN0b3JlU3RyZWFtRm5zID0gW1xuICAgICAgaW50ZXJjZXB0U3RyZWFtKHByb2Nlc3Muc3Rkb3V0LCBvbkludGVyY2VwdCksXG4gICAgICBpbnRlcmNlcHRTdHJlYW0ocHJvY2Vzcy5zdGRlcnIsIG9uSW50ZXJjZXB0KSxcbiAgICBdXG5cbiAgICBzdHJlYW0uY2xlYW5VcCA9ICgpID0+IHtcbiAgICAgIGNsaUN1cnNvci5zaG93KHRoaXMuc3RyZWFtKVxuICAgICAgcmVzdG9yZVN0cmVhbUZucy5mb3JFYWNoKHJlc3RvcmVTdHJlYW0gPT4gcmVzdG9yZVN0cmVhbSgpKVxuICAgIH1cblxuICAgIHJldHVybiBzdHJlYW1cbiAgfVxuXG4gIHByaXZhdGUgc3BpbihlbnRyaWVzOiBUZXJtaW5hbEVudHJ5V2l0aFNwaW5uZXJbXSwgdG90YWxMaW5lczogbnVtYmVyKTogdm9pZCB7XG4gICAgZW50cmllcy5mb3JFYWNoKGUgPT4ge1xuICAgICAgbGV0IG91dCA9IFwiXCJcbiAgICAgIGNvbnN0IFt4LCB5XSA9IGUuc3Bpbm5lckNvb3Jkc1xuICAgICAgY29uc3QgdGVybVggPSB4ID09PSAwID8geCA6IHggKyAxXG4gICAgICBjb25zdCB0ZXJtWSA9IC0odG90YWxMaW5lcyAtIHkgLSAxKVxuICAgICAgb3V0ICs9IGFuc2lFc2NhcGVzLmN1cnNvclNhdmVQb3NpdGlvblxuICAgICAgb3V0ICs9IGFuc2lFc2NhcGVzLmN1cnNvclRvKDApIC8vIEVuc3VyZSBjdXJzb3IgaXMgdG8gdGhlIGxlZnRcbiAgICAgIG91dCArPSBhbnNpRXNjYXBlcy5jdXJzb3JNb3ZlKHRlcm1YLCB0ZXJtWSlcbiAgICAgIG91dCArPSBzcGlubmVyU3R5bGUodGhpcy50aWNrU3Bpbm5lcihlLmtleSkpXG4gICAgICBvdXQgKz0gYW5zaUVzY2FwZXMuY3Vyc29yUmVzdG9yZVBvc2l0aW9uXG4gICAgICB0aGlzLnN0cmVhbS53cml0ZShvdXQpXG4gICAgfSlcbiAgfVxuXG4gIHByaXZhdGUgc3RhcnRMb29wKGVudHJpZXM6IFRlcm1pbmFsRW50cnlXaXRoU3Bpbm5lcltdLCB0b3RhbExpbmVzOiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3BMb29wKClcbiAgICB0aGlzLmludGVydmFsSUQgPSBzZXRJbnRlcnZhbChcbiAgICAgICgpID0+IHRoaXMuc3BpbihlbnRyaWVzLCB0b3RhbExpbmVzKSxcbiAgICAgIElOVEVSVkFMX01TLFxuICAgIClcbiAgfVxuXG4gIHByaXZhdGUgc3RvcExvb3AoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaW50ZXJ2YWxJRCkge1xuICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmludGVydmFsSUQpXG4gICAgICB0aGlzLmludGVydmFsSUQgPSBudWxsXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB0aWNrU3Bpbm5lcihrZXk6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKCF0aGlzLnNwaW5uZXJzW2tleV0pIHtcbiAgICAgIHRoaXMuc3Bpbm5lcnNba2V5XSA9IGVsZWdhbnRTcGlubmVyKClcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuc3Bpbm5lcnNba2V5XSgpXG4gIH1cblxuICBwcml2YXRlIHdyaXRlKG91dHB1dDogc3RyaW5nW10sIG5leHRFbnRyeTogVGVybWluYWxFbnRyeSkge1xuICAgIGNsaUN1cnNvci5oaWRlKHRoaXMuc3RyZWFtKVxuXG4gICAgY29uc3QgbGluZU51bWJlciA9IG91dHB1dC5sZW5ndGggPj0gdGhpcy5wcmV2T3V0cHV0Lmxlbmd0aCA/IG5leHRFbnRyeS5saW5lTnVtYmVyIDogMFxuICAgIGNvbnN0IG5MaW5lc1RvRXJhc2UgPSB0aGlzLnByZXZPdXRwdXQubGVuZ3RoIC0gbGluZU51bWJlclxuICAgIHRoaXMuc3RyZWFtLndyaXRlKFxuICAgICAgYW5zaUVzY2FwZXMuZXJhc2VMaW5lcyhuTGluZXNUb0VyYXNlKSArIG91dHB1dC5zbGljZShsaW5lTnVtYmVyKS5qb2luKFwiXFxuXCIpLFxuICAgIClcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlR3JhcGhDaGFuZ2UobG9nRW50cnk6IExvZ0VudHJ5LCBsb2dnZXI6IExvZ2dlciwgZGlkV3JpdGU6IGJvb2xlYW4gPSBmYWxzZSkge1xuICAgIHRoaXMudXBkYXRlUGVuZGluZyA9IGZhbHNlXG5cbiAgICAvLyBTdXNwZW5kIHByb2Nlc3NpbmcgYW5kIHdyaXRlIGltbWVkaWF0ZWx5IGlmIGEgbG90IG9mIGRhdGEgaXMgYmVpbmcgaW50ZXJjZXB0ZWQsIGUuZy4gd2hlbiB1c2VyIGlzIHR5cGluZyBpbiBpbnB1dFxuICAgIGlmIChsb2dFbnRyeS5mcm9tU3RkU3RyZWFtKCkgJiYgIWRpZFdyaXRlKSB7XG4gICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpXG4gICAgICBjb25zdCB0aHJvdHRsZVByb2Nlc3NpbmcgPSB0aGlzLmxhc3RJbnRlcmNlcHRBdCAmJiAobm93IC0gdGhpcy5sYXN0SW50ZXJjZXB0QXQpIDwgVEhST1RUTEVfTVNcbiAgICAgIHRoaXMubGFzdEludGVyY2VwdEF0ID0gbm93XG5cbiAgICAgIGlmICh0aHJvdHRsZVByb2Nlc3NpbmcpIHtcbiAgICAgICAgdGhpcy5zdG9wTG9vcCgpXG4gICAgICAgIHRoaXMuc3RyZWFtLndyaXRlKHJlbmRlck1zZyhsb2dFbnRyeSkpXG4gICAgICAgIHRoaXMudXBkYXRlUGVuZGluZyA9IHRydWVcblxuICAgICAgICAvLyBSZXN1bWUgcHJvY2Vzc2luZyBpZiBpZGxlIGFuZCBvcmlnaW5hbCB1cGRhdGUgaXMgc3RpbGwgcGVuZGluZ1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy51cGRhdGVQZW5kaW5nKSB7XG4gICAgICAgICAgICB0aGlzLmhhbmRsZUdyYXBoQ2hhbmdlKGxvZ0VudHJ5LCBsb2dnZXIsIHRydWUpXG4gICAgICAgICAgfVxuICAgICAgICB9LCBUSFJPVFRMRV9NUylcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgdGVybWluYWxFbnRyaWVzID0gdGhpcy50b1Rlcm1pbmFsRW50cmllcyhsb2dnZXIpXG4gICAgY29uc3QgbmV4dEVudHJ5ID0gdGVybWluYWxFbnRyaWVzLmZpbmQoZSA9PiBlLmtleSA9PT0gbG9nRW50cnkua2V5KVxuXG4gICAgLy8gTm90aGluZyB0byBkbywgZS5nLiBiZWNhdXNlIGVudHJ5IGxldmVsIGlzIGhpZ2hlciB0aGFuIHdyaXRlciBsZXZlbFxuICAgIGlmICghbmV4dEVudHJ5KSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICBjb25zdCBvdXRwdXQgPSB0aGlzLnJlbmRlcih0ZXJtaW5hbEVudHJpZXMpXG4gICAgaWYgKCFkaWRXcml0ZSkge1xuICAgICAgdGhpcy53cml0ZShvdXRwdXQsIG5leHRFbnRyeSlcbiAgICB9XG5cbiAgICBjb25zdCBlbnRyaWVzV2l0aHNwaW5uZXIgPSA8VGVybWluYWxFbnRyeVdpdGhTcGlubmVyW10+dGVybWluYWxFbnRyaWVzLmZpbHRlcihlID0+IGUuc3Bpbm5lckNvb3JkcylcblxuICAgIGlmIChlbnRyaWVzV2l0aHNwaW5uZXIubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy5zdGFydExvb3AoZW50cmllc1dpdGhzcGlubmVyLCBvdXRwdXQubGVuZ3RoKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnN0b3BMb29wKClcbiAgICB9XG5cbiAgICB0aGlzLnByZXZPdXRwdXQgPSBvdXRwdXRcbiAgfVxuXG4gIHB1YmxpYyB0b1Rlcm1pbmFsRW50cmllcyhsb2dnZXI6IExvZ2dlcik6IFRlcm1pbmFsRW50cnlbXSB7XG4gICAgY29uc3QgbGV2ZWwgPSB0aGlzLmxldmVsIHx8IGxvZ2dlci5sZXZlbFxuICAgIGxldCBjdXJyZW50TGluZU51bWJlciA9IDBcblxuICAgIHJldHVybiBnZXRDaGlsZEVudHJpZXMobG9nZ2VyKVxuICAgICAgLmZpbHRlcihlbnRyeSA9PiB2YWxpZGF0ZShsZXZlbCwgZW50cnkpKVxuICAgICAgLnJlZHVjZSgoYWNjOiBUZXJtaW5hbEVudHJ5W10sIGVudHJ5OiBMb2dFbnRyeSk6IFRlcm1pbmFsRW50cnlbXSA9PiB7XG4gICAgICAgIGxldCBzcGlubmVyRnJhbWUgPSBcIlwiXG4gICAgICAgIGxldCBzcGlubmVyWFxuICAgICAgICBsZXQgc3Bpbm5lckNvb3JkczogQ29vcmRzIHwgdW5kZWZpbmVkXG5cbiAgICAgICAgaWYgKGVudHJ5Lm9wdHMuc3RhdHVzID09PSBcImFjdGl2ZVwiKSB7XG4gICAgICAgICAgc3Bpbm5lclggPSBsZWZ0UGFkKGVudHJ5KS5sZW5ndGhcbiAgICAgICAgICBzcGlubmVyRnJhbWUgPSB0aGlzLnRpY2tTcGlubmVyKGVudHJ5LmtleSlcbiAgICAgICAgICBzcGlubmVyQ29vcmRzID0gW3NwaW5uZXJYLCBjdXJyZW50TGluZU51bWJlcl1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkZWxldGUgdGhpcy5zcGlubmVyc1tlbnRyeS5rZXldXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB0ZXh0ID0gW2VudHJ5XVxuICAgICAgICAgIC5tYXAoZSA9PiAoXG4gICAgICAgICAgICBlLmZyb21TdGRTdHJlYW0oKVxuICAgICAgICAgICAgICA/IHJlbmRlck1zZyhlKVxuICAgICAgICAgICAgICA6IGZvcm1hdEZvclRlcm1pbmFsKGUpXG4gICAgICAgICAgKSlcbiAgICAgICAgICAubWFwKHN0ciA9PiAoXG4gICAgICAgICAgICBzcGlubmVyRnJhbWVcbiAgICAgICAgICAgICAgPyBgJHtzdHIuc2xpY2UoMCwgc3Bpbm5lclgpfSR7c3Bpbm5lclN0eWxlKHNwaW5uZXJGcmFtZSl9ICR7c3RyLnNsaWNlKHNwaW5uZXJYKX1gXG4gICAgICAgICAgICAgIDogc3RyXG4gICAgICAgICAgKSlcbiAgICAgICAgICAubWFwKHN0ciA9PiB3cmFwQW5zaShzdHIsIGdldFRlcm1pbmFsV2lkdGgodGhpcy5zdHJlYW0pLCB7XG4gICAgICAgICAgICB0cmltOiBmYWxzZSxcbiAgICAgICAgICAgIGhhcmQ6IHRydWUsXG4gICAgICAgICAgICB3b3JkV3JhcDogZmFsc2UsXG4gICAgICAgICAgfSkpXG4gICAgICAgICAgLnBvcCgpIVxuXG4gICAgICAgIGFjYy5wdXNoKHtcbiAgICAgICAgICBrZXk6IGVudHJ5LmtleSxcbiAgICAgICAgICBsaW5lTnVtYmVyOiBjdXJyZW50TGluZU51bWJlcixcbiAgICAgICAgICBzcGlubmVyQ29vcmRzLFxuICAgICAgICAgIHRleHQsXG4gICAgICAgIH0pXG5cbiAgICAgICAgY3VycmVudExpbmVOdW1iZXIgKz0gdGV4dC5zcGxpdChcIlxcblwiKS5sZW5ndGggLSAxXG5cbiAgICAgICAgcmV0dXJuIGFjY1xuICAgICAgfSwgW10pXG4gIH1cblxuICBwdWJsaWMgcmVuZGVyKHRlcm1pbmFsRW50cmllczogVGVybWluYWxFbnRyeVtdKTogc3RyaW5nW10ge1xuICAgIHJldHVybiB0ZXJtaW5hbEVudHJpZXMubWFwKGUgPT4gZS50ZXh0KS5qb2luKFwiXCIpLnNwbGl0KFwiXFxuXCIpXG4gIH1cblxuICBwdWJsaWMgb25HcmFwaENoYW5nZShsb2dFbnRyeTogTG9nRW50cnksIGxvZ2dlcjogTG9nZ2VyKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnN0cmVhbSkge1xuICAgICAgdGhpcy5zdHJlYW0gPSB0aGlzLmluaXRTdHJlYW0obG9nZ2VyKVxuICAgIH1cblxuICAgIHRoaXMuaGFuZGxlR3JhcGhDaGFuZ2UobG9nRW50cnksIGxvZ2dlciwgZmFsc2UpXG4gIH1cblxuICBwdWJsaWMgc3RvcCgpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3BMb29wKClcbiAgICB0aGlzLnN0cmVhbSAmJiB0aGlzLnN0cmVhbS5jbGVhblVwKClcbiAgfVxuXG59XG4iXX0=
