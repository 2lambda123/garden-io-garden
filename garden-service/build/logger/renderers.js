"use strict";
/*
 * Copyright (C) 2018 Garden Technologies, Inc. <info@garden.io>
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const logSymbols = require("log-symbols");
const nodeEmoji = require("node-emoji");
const yaml = require("js-yaml");
const chalk_1 = require("chalk");
const lodash_1 = require("lodash");
const cliTruncate = require("cli-truncate");
const stringWidth = require("string-width");
const hasAnsi = require("has-ansi");
/*** STYLE HELPERS ***/
const SECTION_PREFIX_WIDTH = 25;
const cliPadEnd = (s, width) => {
    const diff = width - stringWidth(s);
    return diff <= 0 ? s : s + lodash_1.repeat(" ", diff);
};
const truncateSection = (s) => cliTruncate(s, SECTION_PREFIX_WIDTH);
const sectionStyle = (s) => chalk_1.default.cyan.italic(cliPadEnd(truncateSection(s), SECTION_PREFIX_WIDTH));
exports.msgStyle = (s) => hasAnsi(s) ? s : chalk_1.default.gray(s);
exports.errorStyle = chalk_1.default.red;
/*** RENDER HELPERS ***/
function insertVal(out, idx, toRender, renderArgs) {
    out[idx] = typeof toRender === "string" ? toRender : toRender(...renderArgs);
    return out;
}
// Creates a chain of renderers that each receives the updated output array along with the provided parameters
function applyRenderers(renderers) {
    const curried = renderers.map(([toRender, renderArgs], idx) => {
        const args = [idx, toRender, renderArgs];
        // FIXME Currying like this throws "Expected 0-4 arguments, but got 0 or more"
        return lodash_1.curryRight(insertVal)(...args);
    });
    return lodash_1.flow(curried);
}
function combine(renderers) {
    const initOutput = [];
    return applyRenderers(renderers)(initOutput).join("");
}
exports.combine = combine;
/*** RENDERERS ***/
function leftPad(entry) {
    return lodash_1.padStart("", (entry.opts.indentationLevel || 0) * 3);
}
exports.leftPad = leftPad;
function renderEmoji(entry) {
    const { emoji } = entry.opts;
    if (emoji && nodeEmoji.hasEmoji(emoji)) {
        return `${nodeEmoji.get(emoji)}  `;
    }
    return "";
}
exports.renderEmoji = renderEmoji;
function renderError(entry) {
    const { msg, error } = entry.opts;
    if (error) {
        const { detail, message, stack } = error;
        let out = stack || message;
        if (!lodash_1.isEmpty(detail)) {
            const kebabCasedDetail = lodash_1.reduce(detail, (acc, val, key) => {
                acc[lodash_1.kebabCase(key)] = val;
                return acc;
            }, {});
            const yamlDetail = yaml.safeDump(kebabCasedDetail, { noRefs: true, skipInvalid: true });
            out += `\nError Details:\n${yamlDetail}`;
        }
        return out;
    }
    return msg || "";
}
exports.renderError = renderError;
function renderSymbol(entry) {
    const { symbol } = entry.opts;
    if (symbol === "empty") {
        return " ";
    }
    return symbol ? `${logSymbols[symbol]} ` : "";
}
exports.renderSymbol = renderSymbol;
function renderMsg(entry) {
    const { fromStdStream, msg, status } = entry.opts;
    if (fromStdStream) {
        return lodash_1.isArray(msg) ? msg.join(" ") : msg || "";
    }
    const styleFn = status === "error" ? exports.errorStyle : exports.msgStyle;
    if (lodash_1.isArray(msg)) {
        // We apply the style function to each item (as opposed to the entire string) in case some
        // part of the message already has a style
        return msg.map(str => styleFn(str)).join(styleFn(" → "));
    }
    return msg ? styleFn(msg) : "";
}
exports.renderMsg = renderMsg;
function renderSection(entry) {
    const { section } = entry.opts;
    return section ? `${sectionStyle(section)} → ` : "";
}
exports.renderSection = renderSection;
function renderDuration(entry) {
    const { showDuration = false } = entry.opts;
    return showDuration
        ? exports.msgStyle(` (finished in ${entry.getDuration()}s)`)
        : "";
}
exports.renderDuration = renderDuration;
function formatForTerminal(entry) {
    return combine([
        [leftPad, [entry]],
        [renderSymbol, [entry]],
        [renderSection, [entry]],
        [renderEmoji, [entry]],
        [renderMsg, [entry]],
        [renderDuration, [entry]],
        ["\n"],
    ]);
}
exports.formatForTerminal = formatForTerminal;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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LENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUE7QUFDckQsQ0FBQztBQUhELHNDQUdDO0FBRUQsU0FBZ0IsY0FBYyxDQUFDLEtBQWU7SUFDNUMsTUFBTSxFQUFFLFlBQVksR0FBRyxLQUFLLEVBQUUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFBO0lBQzNDLE9BQU8sWUFBWTtRQUNqQixDQUFDLENBQUMsZ0JBQVEsQ0FBQyxpQkFBaUIsS0FBSyxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUM7UUFDcEQsQ0FBQyxDQUFDLEVBQUUsQ0FBQTtBQUNSLENBQUM7QUFMRCx3Q0FLQztBQUVELFNBQWdCLGlCQUFpQixDQUFDLEtBQWU7SUFDL0MsT0FBTyxPQUFPLENBQUM7UUFDYixDQUFDLE9BQU8sRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2xCLENBQUMsWUFBWSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdkIsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN4QixDQUFDLFdBQVcsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3RCLENBQUMsU0FBUyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDcEIsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN6QixDQUFDLElBQUksQ0FBQztLQUNQLENBQUMsQ0FBQTtBQUNKLENBQUM7QUFWRCw4Q0FVQyIsImZpbGUiOiJsb2dnZXIvcmVuZGVyZXJzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAoQykgMjAxOCBHYXJkZW4gVGVjaG5vbG9naWVzLCBJbmMuIDxpbmZvQGdhcmRlbi5pbz5cbiAqXG4gKiBUaGlzIFNvdXJjZSBDb2RlIEZvcm0gaXMgc3ViamVjdCB0byB0aGUgdGVybXMgb2YgdGhlIE1vemlsbGEgUHVibGljXG4gKiBMaWNlbnNlLCB2LiAyLjAuIElmIGEgY29weSBvZiB0aGUgTVBMIHdhcyBub3QgZGlzdHJpYnV0ZWQgd2l0aCB0aGlzXG4gKiBmaWxlLCBZb3UgY2FuIG9idGFpbiBvbmUgYXQgaHR0cDovL21vemlsbGEub3JnL01QTC8yLjAvLlxuICovXG5cbmltcG9ydCAqIGFzIGxvZ1N5bWJvbHMgZnJvbSBcImxvZy1zeW1ib2xzXCJcbmltcG9ydCAqIGFzIG5vZGVFbW9qaSBmcm9tIFwibm9kZS1lbW9qaVwiXG5pbXBvcnQgKiBhcyB5YW1sIGZyb20gXCJqcy15YW1sXCJcbmltcG9ydCBjaGFsayBmcm9tIFwiY2hhbGtcIlxuaW1wb3J0IHtcbiAgY3VycnlSaWdodCxcbiAgZmxvdyxcbiAgaXNBcnJheSxcbiAgaXNFbXB0eSxcbiAgcGFkU3RhcnQsXG4gIHJlZHVjZSxcbiAga2ViYWJDYXNlLFxuICByZXBlYXQsXG59IGZyb20gXCJsb2Rhc2hcIlxuaW1wb3J0IGNsaVRydW5jYXRlID0gcmVxdWlyZShcImNsaS10cnVuY2F0ZVwiKVxuaW1wb3J0IHN0cmluZ1dpZHRoID0gcmVxdWlyZShcInN0cmluZy13aWR0aFwiKVxuaW1wb3J0IGhhc0Fuc2kgPSByZXF1aXJlKFwiaGFzLWFuc2lcIilcblxuaW1wb3J0IHsgTG9nRW50cnkgfSBmcm9tIFwiLi9sb2ctZW50cnlcIlxuXG5leHBvcnQgdHlwZSBUb1JlbmRlciA9IHN0cmluZyB8ICgoLi4uYXJnczogYW55W10pID0+IHN0cmluZylcbmV4cG9ydCB0eXBlIFJlbmRlcmVyID0gW1RvUmVuZGVyLCBhbnlbXV0gfCBUb1JlbmRlcltdXG5leHBvcnQgdHlwZSBSZW5kZXJlcnMgPSBSZW5kZXJlcltdXG5cbi8qKiogU1RZTEUgSEVMUEVSUyAqKiovXG5cbmNvbnN0IFNFQ1RJT05fUFJFRklYX1dJRFRIID0gMjVcbmNvbnN0IGNsaVBhZEVuZCA9IChzOiBzdHJpbmcsIHdpZHRoOiBudW1iZXIpOiBzdHJpbmcgPT4ge1xuICBjb25zdCBkaWZmID0gd2lkdGggLSBzdHJpbmdXaWR0aChzKVxuICByZXR1cm4gZGlmZiA8PSAwID8gcyA6IHMgKyByZXBlYXQoXCIgXCIsIGRpZmYpXG59XG5jb25zdCB0cnVuY2F0ZVNlY3Rpb24gPSAoczogc3RyaW5nKSA9PiBjbGlUcnVuY2F0ZShzLCBTRUNUSU9OX1BSRUZJWF9XSURUSClcbmNvbnN0IHNlY3Rpb25TdHlsZSA9IChzOiBzdHJpbmcpID0+IGNoYWxrLmN5YW4uaXRhbGljKGNsaVBhZEVuZCh0cnVuY2F0ZVNlY3Rpb24ocyksIFNFQ1RJT05fUFJFRklYX1dJRFRIKSlcbmV4cG9ydCBjb25zdCBtc2dTdHlsZSA9IChzOiBzdHJpbmcpID0+IGhhc0Fuc2kocykgPyBzIDogY2hhbGsuZ3JheShzKVxuZXhwb3J0IGNvbnN0IGVycm9yU3R5bGUgPSBjaGFsay5yZWRcblxuLyoqKiBSRU5ERVIgSEVMUEVSUyAqKiovXG5mdW5jdGlvbiBpbnNlcnRWYWwob3V0OiBzdHJpbmdbXSwgaWR4OiBudW1iZXIsIHRvUmVuZGVyOiBGdW5jdGlvbiB8IHN0cmluZywgcmVuZGVyQXJnczogYW55W10pOiBzdHJpbmdbXSB7XG4gIG91dFtpZHhdID0gdHlwZW9mIHRvUmVuZGVyID09PSBcInN0cmluZ1wiID8gdG9SZW5kZXIgOiB0b1JlbmRlciguLi5yZW5kZXJBcmdzKVxuICByZXR1cm4gb3V0XG59XG5cbi8vIENyZWF0ZXMgYSBjaGFpbiBvZiByZW5kZXJlcnMgdGhhdCBlYWNoIHJlY2VpdmVzIHRoZSB1cGRhdGVkIG91dHB1dCBhcnJheSBhbG9uZyB3aXRoIHRoZSBwcm92aWRlZCBwYXJhbWV0ZXJzXG5mdW5jdGlvbiBhcHBseVJlbmRlcmVycyhyZW5kZXJlcnM6IFJlbmRlcmVycyk6IEZ1bmN0aW9uIHtcbiAgY29uc3QgY3VycmllZCA9IHJlbmRlcmVycy5tYXAoKFt0b1JlbmRlciwgcmVuZGVyQXJnc106IFJlbmRlcmVyLCBpZHg6IG51bWJlcikgPT4ge1xuICAgIGNvbnN0IGFyZ3MgPSBbaWR4LCB0b1JlbmRlciwgcmVuZGVyQXJnc11cbiAgICAvLyBGSVhNRSBDdXJyeWluZyBsaWtlIHRoaXMgdGhyb3dzIFwiRXhwZWN0ZWQgMC00IGFyZ3VtZW50cywgYnV0IGdvdCAwIG9yIG1vcmVcIlxuICAgIHJldHVybiAoPGFueT5jdXJyeVJpZ2h0KShpbnNlcnRWYWwpKC4uLmFyZ3MpXG4gIH0pXG4gIHJldHVybiBmbG93KGN1cnJpZWQpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb21iaW5lKHJlbmRlcmVyczogUmVuZGVyZXJzKTogc3RyaW5nIHtcbiAgY29uc3QgaW5pdE91dHB1dCA9IFtdXG4gIHJldHVybiBhcHBseVJlbmRlcmVycyhyZW5kZXJlcnMpKGluaXRPdXRwdXQpLmpvaW4oXCJcIilcbn1cblxuLyoqKiBSRU5ERVJFUlMgKioqL1xuZXhwb3J0IGZ1bmN0aW9uIGxlZnRQYWQoZW50cnk6IExvZ0VudHJ5KTogc3RyaW5nIHtcbiAgcmV0dXJuIHBhZFN0YXJ0KFwiXCIsIChlbnRyeS5vcHRzLmluZGVudGF0aW9uTGV2ZWwgfHwgMCkgKiAzKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVuZGVyRW1vamkoZW50cnk6IExvZ0VudHJ5KTogc3RyaW5nIHtcbiAgY29uc3QgeyBlbW9qaSB9ID0gZW50cnkub3B0c1xuICBpZiAoZW1vamkgJiYgbm9kZUVtb2ppLmhhc0Vtb2ppKGVtb2ppKSkge1xuICAgIHJldHVybiBgJHtub2RlRW1vamkuZ2V0KGVtb2ppKX0gIGBcbiAgfVxuICByZXR1cm4gXCJcIlxufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVuZGVyRXJyb3IoZW50cnk6IExvZ0VudHJ5KSB7XG4gIGNvbnN0IHsgbXNnLCBlcnJvciB9ID0gZW50cnkub3B0c1xuICBpZiAoZXJyb3IpIHtcbiAgICBjb25zdCB7IGRldGFpbCwgbWVzc2FnZSwgc3RhY2sgfSA9IGVycm9yXG4gICAgbGV0IG91dCA9IHN0YWNrIHx8IG1lc3NhZ2VcbiAgICBpZiAoIWlzRW1wdHkoZGV0YWlsKSkge1xuICAgICAgY29uc3Qga2ViYWJDYXNlZERldGFpbCA9IHJlZHVjZShkZXRhaWwsIChhY2MsIHZhbCwga2V5KSA9PiB7XG4gICAgICAgIGFjY1trZWJhYkNhc2Uoa2V5KV0gPSB2YWxcbiAgICAgICAgcmV0dXJuIGFjY1xuICAgICAgfSwge30pXG4gICAgICBjb25zdCB5YW1sRGV0YWlsID0geWFtbC5zYWZlRHVtcChrZWJhYkNhc2VkRGV0YWlsLCB7IG5vUmVmczogdHJ1ZSwgc2tpcEludmFsaWQ6IHRydWUgfSlcbiAgICAgIG91dCArPSBgXFxuRXJyb3IgRGV0YWlsczpcXG4ke3lhbWxEZXRhaWx9YFxuICAgIH1cbiAgICByZXR1cm4gb3V0XG4gIH1cbiAgcmV0dXJuIG1zZyB8fCBcIlwiXG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW5kZXJTeW1ib2woZW50cnk6IExvZ0VudHJ5KTogc3RyaW5nIHtcbiAgY29uc3QgeyBzeW1ib2wgfSA9IGVudHJ5Lm9wdHNcbiAgaWYgKHN5bWJvbCA9PT0gXCJlbXB0eVwiKSB7XG4gICAgcmV0dXJuIFwiIFwiXG4gIH1cbiAgcmV0dXJuIHN5bWJvbCA/IGAke2xvZ1N5bWJvbHNbc3ltYm9sXX0gYCA6IFwiXCJcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlbmRlck1zZyhlbnRyeTogTG9nRW50cnkpOiBzdHJpbmcge1xuICBjb25zdCB7IGZyb21TdGRTdHJlYW0sIG1zZywgc3RhdHVzIH0gPSBlbnRyeS5vcHRzXG5cbiAgaWYgKGZyb21TdGRTdHJlYW0pIHtcbiAgICByZXR1cm4gaXNBcnJheShtc2cpID8gbXNnLmpvaW4oXCIgXCIpIDogbXNnIHx8IFwiXCJcbiAgfVxuXG4gIGNvbnN0IHN0eWxlRm4gPSBzdGF0dXMgPT09IFwiZXJyb3JcIiA/IGVycm9yU3R5bGUgOiBtc2dTdHlsZVxuICBpZiAoaXNBcnJheShtc2cpKSB7XG4gICAgLy8gV2UgYXBwbHkgdGhlIHN0eWxlIGZ1bmN0aW9uIHRvIGVhY2ggaXRlbSAoYXMgb3Bwb3NlZCB0byB0aGUgZW50aXJlIHN0cmluZykgaW4gY2FzZSBzb21lXG4gICAgLy8gcGFydCBvZiB0aGUgbWVzc2FnZSBhbHJlYWR5IGhhcyBhIHN0eWxlXG4gICAgcmV0dXJuIG1zZy5tYXAoc3RyID0+IHN0eWxlRm4oc3RyKSkuam9pbihzdHlsZUZuKFwiIOKGkiBcIikpXG4gIH1cbiAgcmV0dXJuIG1zZyA/IHN0eWxlRm4obXNnKSA6IFwiXCJcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlbmRlclNlY3Rpb24oZW50cnk6IExvZ0VudHJ5KTogc3RyaW5nIHtcbiAgY29uc3QgeyBzZWN0aW9uIH0gPSBlbnRyeS5vcHRzXG4gIHJldHVybiBzZWN0aW9uID8gYCR7c2VjdGlvblN0eWxlKHNlY3Rpb24pfSDihpIgYCA6IFwiXCJcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlbmRlckR1cmF0aW9uKGVudHJ5OiBMb2dFbnRyeSk6IHN0cmluZyB7XG4gIGNvbnN0IHsgc2hvd0R1cmF0aW9uID0gZmFsc2UgfSA9IGVudHJ5Lm9wdHNcbiAgcmV0dXJuIHNob3dEdXJhdGlvblxuICAgID8gbXNnU3R5bGUoYCAoZmluaXNoZWQgaW4gJHtlbnRyeS5nZXREdXJhdGlvbigpfXMpYClcbiAgICA6IFwiXCJcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdEZvclRlcm1pbmFsKGVudHJ5OiBMb2dFbnRyeSk6IHN0cmluZyB7XG4gIHJldHVybiBjb21iaW5lKFtcbiAgICBbbGVmdFBhZCwgW2VudHJ5XV0sXG4gICAgW3JlbmRlclN5bWJvbCwgW2VudHJ5XV0sXG4gICAgW3JlbmRlclNlY3Rpb24sIFtlbnRyeV1dLFxuICAgIFtyZW5kZXJFbW9qaSwgW2VudHJ5XV0sXG4gICAgW3JlbmRlck1zZywgW2VudHJ5XV0sXG4gICAgW3JlbmRlckR1cmF0aW9uLCBbZW50cnldXSxcbiAgICBbXCJcXG5cIl0sXG4gIF0pXG59XG4iXX0=
