"use strict";
/*
 * Copyright (C) 2018 Garden Technologies, Inc. <info@garden.io>
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const Joi = require("joi");
const dedent = require("dedent");
const common_1 = require("../../config/common");
const project_1 = require("../../config/project");
const actions_1 = require("./actions");
const deployment_1 = require("./deployment");
const helm_1 = require("./helm");
const secrets_1 = require("./secrets");
const container_1 = require("../container");
const init_1 = require("./init");
exports.name = "kubernetes";
exports.k8sContextSchema = Joi.string()
    .required()
    .description("The kubectl context to use to connect to the Kubernetes cluster.")
    .example("my-dev-context");
const secretRef = Joi.object()
    .keys({
    name: common_1.joiIdentifier()
        .required()
        .description("The name of the Kubernetes secret.")
        .example("my-secret"),
    namespace: common_1.joiIdentifier()
        .default("default")
        .description("The namespace where the secret is stored. " +
        "If necessary, the secret may be copied to the appropriate namespace before use."),
})
    .description("Reference to a Kubernetes secret.");
const imagePullSecretsSchema = common_1.joiArray(secretRef)
    .description(dedent `
    References to \`docker-registry\` secrets to use for authenticating with remote registries when pulling
    images. This is necessary if you reference private images in your module configuration, and is required
    when configuring a remote Kubernetes environment.
  `);
const tlsCertificateSchema = Joi.object()
    .keys({
    name: common_1.joiIdentifier()
        .required()
        .description("A unique identifier for this certificate.")
        .example("www")
        .example("wildcard"),
    hostnames: Joi.array().items(Joi.string().hostname())
        .description("A list of hostnames that this certificate should be used for. " +
        "If you don't specify these, they will be automatically read from the certificate.")
        .example(["www.mydomain.com"]),
    secretRef: secretRef
        .description("A reference to the Kubernetes secret that contains the TLS certificate and key for the domain.")
        .example({ name: "my-tls-secret", namespace: "default" }),
});
exports.kubernetesConfigBase = project_1.providerConfigBaseSchema
    .keys({
    defaultHostname: Joi.string()
        .description("A default hostname to use when no hostname is explicitly configured for a service.")
        .example("api.mydomain.com"),
    defaultUsername: common_1.joiIdentifier()
        .description("Set a default username (used for namespacing within a cluster)."),
    forceSsl: Joi.boolean()
        .default(false)
        .description("Require SSL on all services. If set to true, an error is raised when no certificate " +
        "is available for a configured hostname."),
    imagePullSecrets: imagePullSecretsSchema,
    namespace: Joi.string()
        .description("Specify which namespace to deploy services to (auto-generated by default). " +
        "Note that the framework generates other namespaces as well with this name as a prefix."),
    tlsCertificates: common_1.joiArray(tlsCertificateSchema)
        .unique("name")
        .description("One or more certificates to use for ingress."),
});
const configSchema = exports.kubernetesConfigBase
    .keys({
    context: exports.k8sContextSchema
        .required(),
    deploymentRegistry: container_1.containerRegistryConfigSchema,
    ingressClass: Joi.string()
        .default("nginx")
        .description(dedent `
        The ingress class to use on configured Ingresses when deploying services. **Note that Garden
        currently only supports the nginx ingress controller.**
      `),
    ingressHttpPort: Joi.number()
        .default(80)
        .description("The external HTTP port of the cluster's ingress controller."),
    ingressHttpsPort: Joi.number()
        .default(443)
        .description("The external HTTPS port of the cluster's ingress controller."),
    _system: Joi.any().meta({ internal: true }),
});
function gardenPlugin({ config }) {
    config = common_1.validate(config, configSchema, { context: "kubernetes provider config" });
    return {
        config,
        actions: {
            getEnvironmentStatus: init_1.getRemoteEnvironmentStatus,
            prepareEnvironment: init_1.prepareRemoteEnvironment,
            cleanupEnvironment: init_1.cleanupEnvironment,
            getSecret: secrets_1.getSecret,
            setSecret: secrets_1.setSecret,
            deleteSecret: secrets_1.deleteSecret,
        },
        moduleActions: {
            container: {
                getServiceStatus: deployment_1.getContainerServiceStatus,
                deployService: deployment_1.deployContainerService,
                deleteService: actions_1.deleteService,
                getServiceOutputs: actions_1.getServiceOutputs,
                execInService: actions_1.execInService,
                pushModule: deployment_1.pushModule,
                runModule: actions_1.runModule,
                testModule: actions_1.testModule,
                runService: actions_1.runService,
                getTestResult: actions_1.getTestResult,
                getServiceLogs: actions_1.getServiceLogs,
            },
            helm: helm_1.helmHandlers,
        },
    };
}
exports.gardenPlugin = gardenPlugin;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBsdWdpbnMva3ViZXJuZXRlcy9rdWJlcm5ldGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7O0dBTUc7O0FBRUgsMkJBQTBCO0FBQzFCLGlDQUFpQztBQUVqQyxnREFJNEI7QUFFNUIsa0RBQXlGO0FBQ3pGLHVDQVNrQjtBQUNsQiw2Q0FBNEY7QUFDNUYsaUNBQXFDO0FBQ3JDLHVDQUE4RDtBQUM5RCw0Q0FBcUY7QUFDckYsaUNBQWlHO0FBRXBGLFFBQUEsSUFBSSxHQUFHLFlBQVksQ0FBQTtBQWdDbkIsUUFBQSxnQkFBZ0IsR0FBRyxHQUFHLENBQUMsTUFBTSxFQUFFO0tBQ3pDLFFBQVEsRUFBRTtLQUNWLFdBQVcsQ0FBQyxrRUFBa0UsQ0FBQztLQUMvRSxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQTtBQUU1QixNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsTUFBTSxFQUFFO0tBQzNCLElBQUksQ0FBQztJQUNKLElBQUksRUFBRSxzQkFBYSxFQUFFO1NBQ2xCLFFBQVEsRUFBRTtTQUNWLFdBQVcsQ0FBQyxvQ0FBb0MsQ0FBQztTQUNqRCxPQUFPLENBQUMsV0FBVyxDQUFDO0lBQ3ZCLFNBQVMsRUFBRSxzQkFBYSxFQUFFO1NBQ3ZCLE9BQU8sQ0FBQyxTQUFTLENBQUM7U0FDbEIsV0FBVyxDQUNWLDRDQUE0QztRQUM1QyxpRkFBaUYsQ0FDbEY7Q0FDSixDQUFDO0tBQ0QsV0FBVyxDQUFDLG1DQUFtQyxDQUFDLENBQUE7QUFFbkQsTUFBTSxzQkFBc0IsR0FBRyxpQkFBUSxDQUFDLFNBQVMsQ0FBQztLQUMvQyxXQUFXLENBQUMsTUFBTSxDQUFBOzs7O0dBSWxCLENBQUMsQ0FBQTtBQUVKLE1BQU0sb0JBQW9CLEdBQUcsR0FBRyxDQUFDLE1BQU0sRUFBRTtLQUN0QyxJQUFJLENBQUM7SUFDSixJQUFJLEVBQUUsc0JBQWEsRUFBRTtTQUNsQixRQUFRLEVBQUU7U0FDVixXQUFXLENBQUMsMkNBQTJDLENBQUM7U0FDeEQsT0FBTyxDQUFD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VixTQUFTLEVBQVQsbUJBQVM7Z0JBQ1QsVUFBVSxFQUFWLG9CQUFVO2dCQUNWLFVBQVUsRUFBVixvQkFBVTtnQkFDVixhQUFhLEVBQWIsdUJBQWE7Z0JBQ2IsY0FBYyxFQUFkLHdCQUFjO2FBQ2Y7WUFDRCxJQUFJLEVBQUUsbUJBQVk7U0FDbkI7S0FDRixDQUFBO0FBQ0gsQ0FBQztBQTlCRCxvQ0E4QkMiLCJmaWxlIjoicGx1Z2lucy9rdWJlcm5ldGVzL2t1YmVybmV0ZXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IChDKSAyMDE4IEdhcmRlbiBUZWNobm9sb2dpZXMsIEluYy4gPGluZm9AZ2FyZGVuLmlvPlxuICpcbiAqIFRoaXMgU291cmNlIENvZGUgRm9ybSBpcyBzdWJqZWN0IHRvIHRoZSB0ZXJtcyBvZiB0aGUgTW96aWxsYSBQdWJsaWNcbiAqIExpY2Vuc2UsIHYuIDIuMC4gSWYgYSBjb3B5IG9mIHRoZSBNUEwgd2FzIG5vdCBkaXN0cmlidXRlZCB3aXRoIHRoaXNcbiAqIGZpbGUsIFlvdSBjYW4gb2J0YWluIG9uZSBhdCBodHRwOi8vbW96aWxsYS5vcmcvTVBMLzIuMC8uXG4gKi9cblxuaW1wb3J0ICogYXMgSm9pIGZyb20gXCJqb2lcIlxuaW1wb3J0IGRlZGVudCA9IHJlcXVpcmUoXCJkZWRlbnRcIilcblxuaW1wb3J0IHtcbiAgam9pQXJyYXksXG4gIGpvaUlkZW50aWZpZXIsXG4gIHZhbGlkYXRlLFxufSBmcm9tIFwiLi4vLi4vY29uZmlnL2NvbW1vblwiXG5pbXBvcnQgeyBHYXJkZW5QbHVnaW4gfSBmcm9tIFwiLi4vLi4vdHlwZXMvcGx1Z2luL3BsdWdpblwiXG5pbXBvcnQgeyBQcm92aWRlciwgcHJvdmlkZXJDb25maWdCYXNlU2NoZW1hLCBQcm92aWRlckNvbmZpZyB9IGZyb20gXCIuLi8uLi9jb25maWcvcHJvamVjdFwiXG5pbXBvcnQge1xuICBkZWxldGVTZXJ2aWNlLFxuICBleGVjSW5TZXJ2aWNlLFxuICBnZXRTZXJ2aWNlTG9ncyxcbiAgZ2V0U2VydmljZU91dHB1dHMsXG4gIGdldFRlc3RSZXN1bHQsXG4gIHRlc3RNb2R1bGUsXG4gIHJ1bk1vZHVsZSxcbiAgcnVuU2VydmljZSxcbn0gZnJvbSBcIi4vYWN0aW9uc1wiXG5pbXBvcnQgeyBkZXBsb3lDb250YWluZXJTZXJ2aWNlLCBnZXRDb250YWluZXJTZXJ2aWNlU3RhdHVzLCBwdXNoTW9kdWxlIH0gZnJvbSBcIi4vZGVwbG95bWVudFwiXG5pbXBvcnQgeyBoZWxtSGFuZGxlcnMgfSBmcm9tIFwiLi9oZWxtXCJcbmltcG9ydCB7IGdldFNlY3JldCwgc2V0U2VjcmV0LCBkZWxldGVTZWNyZXQgfSBmcm9tIFwiLi9zZWNyZXRzXCJcbmltcG9ydCB7IGNvbnRhaW5lclJlZ2lzdHJ5Q29uZmlnU2NoZW1hLCBDb250YWluZXJSZWdpc3RyeUNvbmZpZyB9IGZyb20gXCIuLi9jb250YWluZXJcIlxuaW1wb3J0IHsgZ2V0UmVtb3RlRW52aXJvbm1lbnRTdGF0dXMsIHByZXBhcmVSZW1vdGVFbnZpcm9ubWVudCwgY2xlYW51cEVudmlyb25tZW50IH0gZnJvbSBcIi4vaW5pdFwiXG5cbmV4cG9ydCBjb25zdCBuYW1lID0gXCJrdWJlcm5ldGVzXCJcblxuZXhwb3J0IGludGVyZmFjZSBTZWNyZXRSZWYge1xuICBuYW1lOiBzdHJpbmdcbiAgbmFtZXNwYWNlOiBzdHJpbmdcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJbmdyZXNzVGxzQ2VydGlmaWNhdGUge1xuICBuYW1lOiBzdHJpbmdcbiAgaG9zdG5hbWVzPzogc3RyaW5nW11cbiAgc2VjcmV0UmVmOiBTZWNyZXRSZWZcbn1cblxuZXhwb3J0IGludGVyZmFjZSBLdWJlcm5ldGVzQmFzZUNvbmZpZyBleHRlbmRzIFByb3ZpZGVyQ29uZmlnIHtcbiAgY29udGV4dDogc3RyaW5nXG4gIGRlZmF1bHRIb3N0bmFtZT86IHN0cmluZ1xuICBkZWZhdWx0VXNlcm5hbWU/OiBzdHJpbmdcbiAgZm9yY2VTc2w6IGJvb2xlYW5cbiAgaW1hZ2VQdWxsU2VjcmV0czogU2VjcmV0UmVmW11cbiAgaW5ncmVzc0h0dHBQb3J0OiBudW1iZXJcbiAgaW5ncmVzc0h0dHBzUG9ydDogbnVtYmVyXG4gIGluZ3Jlc3NDbGFzczogc3RyaW5nXG4gIG5hbWVzcGFjZT86IHN0cmluZ1xuICB0bHNDZXJ0aWZpY2F0ZXM6IEluZ3Jlc3NUbHNDZXJ0aWZpY2F0ZVtdXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgS3ViZXJuZXRlc0NvbmZpZyBleHRlbmRzIEt1YmVybmV0ZXNCYXNlQ29uZmlnIHtcbiAgZGVwbG95bWVudFJlZ2lzdHJ5OiBDb250YWluZXJSZWdpc3RyeUNvbmZpZ1xufVxuXG5leHBvcnQgdHlwZSBLdWJlcm5ldGVzUHJvdmlkZXIgPSBQcm92aWRlcjxLdWJlcm5ldGVzQ29uZmlnPlxuXG5leHBvcnQgY29uc3QgazhzQ29udGV4dFNjaGVtYSA9IEpvaS5zdHJpbmcoKVxuICAucmVxdWlyZWQoKVxuICAuZGVzY3JpcHRpb24oXCJUaGUga3ViZWN0bCBjb250ZXh0IHRvIHVzZSB0byBjb25uZWN0IHRvIHRoZSBLdWJlcm5ldGVzIGNsdXN0ZXIuXCIpXG4gIC5leGFtcGxlKFwibXktZGV2LWNvbnRleHRcIilcblxuY29uc3Qgc2VjcmV0UmVmID0gSm9pLm9iamVjdCgpXG4gIC5rZXlzKHtcbiAgICBuYW1lOiBqb2lJZGVudGlmaWVyKClcbiAgICAgIC5yZXF1aXJlZCgpXG4gICAgICAuZGVzY3JpcHRpb24oXCJUaGUgbmFtZSBvZiB0aGUgS3ViZXJuZXRlcyBzZWNyZXQuXCIpXG4gICAgICAuZXhhbXBsZShcIm15LXNlY3JldFwiKSxcbiAgICBuYW1lc3BhY2U6IGpvaUlkZW50aWZpZXIoKVxuICAgICAgLmRlZmF1bHQoXCJkZWZhdWx0XCIpXG4gICAgICAuZGVzY3JpcHRpb24oXG4gICAgICAgIFwiVGhlIG5hbWVzcGFjZSB3aGVyZSB0aGUgc2VjcmV0IGlzIHN0b3JlZC4gXCIgK1xuICAgICAgICBcIklmIG5lY2Vzc2FyeSwgdGhlIHNlY3JldCBtYXkgYmUgY29waWVkIHRvIHRoZSBhcHByb3ByaWF0ZSBuYW1lc3BhY2UgYmVmb3JlIHVzZS5cIixcbiAgICAgICksXG4gIH0pXG4gIC5kZXNjcmlwdGlvbihcIlJlZmVyZW5jZSB0byBhIEt1YmVybmV0ZXMgc2VjcmV0LlwiKVxuXG5jb25zdCBpbWFnZVB1bGxTZWNyZXRzU2NoZW1hID0gam9pQXJyYXkoc2VjcmV0UmVmKVxuICAuZGVzY3JpcHRpb24oZGVkZW50YFxuICAgIFJlZmVyZW5jZXMgdG8gXFxgZG9ja2VyLXJlZ2lzdHJ5XFxgIHNlY3JldHMgdG8gdXNlIGZvciBhdXRoZW50aWNhdGluZyB3aXRoIHJlbW90ZSByZWdpc3RyaWVzIHdoZW4gcHVsbGluZ1xuICAgIGltYWdlcy4gVGhpcyBpcyBuZWNlc3NhcnkgaWYgeW91IHJlZmVyZW5jZSBwcml2YXRlIGltYWdlcyBpbiB5b3VyIG1vZHVsZSBjb25maWd1cmF0aW9uLCBhbmQgaXMgcmVxdWlyZWRcbiAgICB3aGVuIGNvbmZpZ3VyaW5nIGEgcmVtb3RlIEt1YmVybmV0ZXMgZW52aXJvbm1lbnQuXG4gIGApXG5cbmNvbnN0IHRsc0NlcnRpZmljYXRlU2NoZW1hID0gSm9pLm9iamVjdCgpXG4gIC5rZXlzKHtcbiAgICBuYW1lOiBqb2lJZGVudGlmaWVyKClcbiAgICAgIC5yZXF1aXJlZCgpXG4gICAgICAuZGVzY3JpcHRpb24oXCJBIHVuaXF1ZSBpZGVudGlmaWVyIGZvciB0aGlzIGNlcnRpZmljYXRlLlwiKVxuICAgICAgLmV4YW1wbGUoXCJ3d3dcIilcbiAgICAgIC5leGFtcGxlKFwid2lsZGNhcmRcIiksXG4gICAgaG9zdG5hbWVzOiBKb2kuYXJyYXkoKS5pdGVtcyhKb2kuc3RyaW5nKCkuaG9zdG5hbWUoKSlcbiAgICAgIC5kZXNjcmlwdGlvbihcbiAgICAgICAgXCJBIGxpc3Qgb2YgaG9zdG5hbWVzIHRoYXQgdGhpcyBjZXJ0aWZpY2F0ZSBzaG91bGQgYmUgdXNlZCBmb3IuIFwiICtcbiAgICAgICAgXCJJZiB5b3UgZG9uJ3Qgc3BlY2lmeSB0aGVzZSwgdGhleSB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgcmVhZCBmcm9tIHRoZSBjZXJ0aWZpY2F0ZS5cIixcbiAgICAgIClcbiAgICAgIC5leGFtcGxlKFtcInd3dy5teWRvbWFpbi5jb21cIl0pLFxuICAgIHNlY3JldFJlZjogc2VjcmV0UmVmXG4gICAgICAuZGVzY3JpcHRpb24oXCJBIHJlZmVyZW5jZSB0byB0aGUgS3ViZXJuZXRlcyBzZWNyZXQgdGhhdCBjb250YWlucyB0aGUgVExTIGNlcnRpZmljYXRlIGFuZCBrZXkgZm9yIHRoZSBkb21haW4uXCIpXG4gICAgICAuZXhhbXBsZSh7IG5hbWU6IFwibXktdGxzLXNlY3JldFwiLCBuYW1lc3BhY2U6IFwiZGVmYXVsdFwiIH0pLFxuICB9KVxuXG5leHBvcnQgY29uc3Qga3ViZXJuZXRlc0NvbmZpZ0Jhc2UgPSBwcm92aWRlckNvbmZpZ0Jhc2VTY2hlbWFcbiAgLmtleXMoe1xuICAgIGRlZmF1bHRIb3N0bmFtZTogSm9pLnN0cmluZygpXG4gICAgICAuZGVzY3JpcHRpb24oXCJBIGRlZmF1bHQgaG9zdG5hbWUgdG8gdXNlIHdoZW4gbm8gaG9zdG5hbWUgaXMgZXhwbGljaXRseSBjb25maWd1cmVkIGZvciBhIHNlcnZpY2UuXCIpXG4gICAgICAuZXhhbXBsZShcImFwaS5teWRvbWFpbi5jb21cIiksXG4gICAgZGVmYXVsdFVzZXJuYW1lOiBqb2lJZGVudGlmaWVyKClcbiAgICAgIC5kZXNjcmlwdGlvbihcIlNldCBhIGRlZmF1bHQgdXNlcm5hbWUgKHVzZWQgZm9yIG5hbWVzcGFjaW5nIHdpdGhpbiBhIGNsdXN0ZXIpLlwiKSxcbiAgICBmb3JjZVNzbDogSm9pLmJvb2xlYW4oKVxuICAgICAgLmRlZmF1bHQoZmFsc2UpXG4gICAgICAuZGVzY3JpcHRpb24oXG4gICAgICAgIFwiUmVxdWlyZSBTU0wgb24gYWxsIHNlcnZpY2VzLiBJZiBzZXQgdG8gdHJ1ZSwgYW4gZXJyb3IgaXMgcmFpc2VkIHdoZW4gbm8gY2VydGlmaWNhdGUgXCIgK1xuICAgICAgICBcImlzIGF2YWlsYWJsZSBmb3IgYSBjb25maWd1cmVkIGhvc3RuYW1lLlwiLFxuICAgICAgKSxcbiAgICBpbWFnZVB1bGxTZWNyZXRzOiBpbWFnZVB1bGxTZWNyZXRzU2NoZW1hLFxuICAgIG5hbWVzcGFjZTogSm9pLnN0cmluZygpXG4gICAgICAuZGVzY3JpcHRpb24oXG4gICAgICAgIFwiU3BlY2lmeSB3aGljaCBuYW1lc3BhY2UgdG8gZGVwbG95IHNlcnZpY2VzIHRvIChhdXRvLWdlbmVyYXRlZCBieSBkZWZhdWx0KS4gXCIgK1xuICAgICAgICBcIk5vdGUgdGhhdCB0aGUgZnJhbWV3b3JrIGdlbmVyYXRlcyBvdGhlciBuYW1lc3BhY2VzIGFzIHdlbGwgd2l0aCB0aGlzIG5hbWUgYXMgYSBwcmVmaXguXCIsXG4gICAgICApLFxuICAgIHRsc0NlcnRpZmljYXRlczogam9pQXJyYXkodGxzQ2VydGlmaWNhdGVTY2hlbWEpXG4gICAgICAudW5pcXVlKFwibmFtZVwiKVxuICAgICAgLmRlc2NyaXB0aW9uKFwiT25lIG9yIG1vcmUgY2VydGlmaWNhdGVzIHRvIHVzZSBmb3IgaW5ncmVzcy5cIiksXG4gIH0pXG5cbmNvbnN0IGNvbmZpZ1NjaGVtYSA9IGt1YmVybmV0ZXNDb25maWdCYXNlXG4gIC5rZXlzKHtcbiAgICBjb250ZXh0OiBrOHNDb250ZXh0U2NoZW1hXG4gICAgICAucmVxdWlyZWQoKSxcbiAgICBkZXBsb3ltZW50UmVnaXN0cnk6IGNvbnRhaW5lclJlZ2lzdHJ5Q29uZmlnU2NoZW1hLFxuICAgIGluZ3Jlc3NDbGFzczogSm9pLnN0cmluZygpXG4gICAgICAuZGVmYXVsdChcIm5naW54XCIpXG4gICAgICAuZGVzY3JpcHRpb24oZGVkZW50YFxuICAgICAgICBUaGUgaW5ncmVzcyBjbGFzcyB0byB1c2Ugb24gY29uZmlndXJlZCBJbmdyZXNzZXMgd2hlbiBkZXBsb3lpbmcgc2VydmljZXMuICoqTm90ZSB0aGF0IEdhcmRlblxuICAgICAgICBjdXJyZW50bHkgb25seSBzdXBwb3J0cyB0aGUgbmdpbnggaW5ncmVzcyBjb250cm9sbGVyLioqXG4gICAgICBgKSxcbiAgICBpbmdyZXNzSHR0cFBvcnQ6IEpvaS5udW1iZXIoKVxuICAgICAgLmRlZmF1bHQoODApXG4gICAgICAuZGVzY3JpcHRpb24oXCJUaGUgZXh0ZXJuYWwgSFRUUCBwb3J0IG9mIHRoZSBjbHVzdGVyJ3MgaW5ncmVzcyBjb250cm9sbGVyLlwiKSxcbiAgICBpbmdyZXNzSHR0cHNQb3J0OiBKb2kubnVtYmVyKClcbiAgICAgIC5kZWZhdWx0KDQ0MylcbiAgICAgIC5kZXNjcmlwdGlvbihcIlRoZSBleHRlcm5hbCBIVFRQUyBwb3J0IG9mIHRoZSBjbHVzdGVyJ3MgaW5ncmVzcyBjb250cm9sbGVyLlwiKSxcbiAgICBfc3lzdGVtOiBKb2kuYW55KCkubWV0YSh7IGludGVybmFsOiB0cnVlIH0pLFxuICB9KVxuXG5leHBvcnQgZnVuY3Rpb24gZ2FyZGVuUGx1Z2luKHsgY29uZmlnIH06IHsgY29uZmlnOiBLdWJlcm5ldGVzQ29uZmlnIH0pOiBHYXJkZW5QbHVnaW4ge1xuICBjb25maWcgPSB2YWxpZGF0ZShjb25maWcsIGNvbmZpZ1NjaGVtYSwgeyBjb250ZXh0OiBcImt1YmVybmV0ZXMgcHJvdmlkZXIgY29uZmlnXCIgfSlcblxuICByZXR1cm4ge1xuICAgIGNvbmZpZyxcbiAgICBhY3Rpb25zOiB7XG4gICAgICBnZXRFbnZpcm9ubWVudFN0YXR1czogZ2V0UmVtb3RlRW52aXJvbm1lbnRTdGF0dXMsXG4gICAgICBwcmVwYXJlRW52aXJvbm1lbnQ6IHByZXBhcmVSZW1vdGVFbnZpcm9ubWVudCxcbiAgICAgIGNsZWFudXBFbnZpcm9ubWVudCxcbiAgICAgIGdldFNlY3JldCxcbiAgICAgIHNldFNlY3JldCxcbiAgICAgIGRlbGV0ZVNlY3JldCxcbiAgICB9LFxuICAgIG1vZHVsZUFjdGlvbnM6IHtcbiAgICAgIGNvbnRhaW5lcjoge1xuICAgICAgICBnZXRTZXJ2aWNlU3RhdHVzOiBnZXRDb250YWluZXJTZXJ2aWNlU3RhdHVzLFxuICAgICAgICBkZXBsb3lTZXJ2aWNlOiBkZXBsb3lDb250YWluZXJTZXJ2aWNlLFxuICAgICAgICBkZWxldGVTZXJ2aWNlLFxuICAgICAgICBnZXRTZXJ2aWNlT3V0cHV0cyxcbiAgICAgICAgZXhlY0luU2VydmljZSxcbiAgICAgICAgcHVzaE1vZHVsZSxcbiAgICAgICAgcnVuTW9kdWxlLFxuICAgICAgICB0ZXN0TW9kdWxlLFxuICAgICAgICBydW5TZXJ2aWNlLFxuICAgICAgICBnZXRUZXN0UmVzdWx0LFxuICAgICAgICBnZXRTZXJ2aWNlTG9ncyxcbiAgICAgIH0sXG4gICAgICBoZWxtOiBoZWxtSGFuZGxlcnMsXG4gICAgfSxcbiAgfVxufVxuIl19
