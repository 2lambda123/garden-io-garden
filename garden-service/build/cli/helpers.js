"use strict";
/*
 * Copyright (C) 2018 Garden Technologies, Inc. <info@garden.io>
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const chalk_1 = require("chalk");
const lodash_1 = require("lodash");
const exceptions_1 = require("../exceptions");
// Parameter types T which map between the Parameter<T> class and the Sywac cli library.
// In case we add types that aren't supported natively by Sywac, see: http://sywac.io/docs/sync-config.html#custom
const VALID_PARAMETER_TYPES = ["boolean", "number", "choice", "string", "array:string", "path", "array:path"];
exports.styleConfig = {
    usagePrefix: str => (`
${chalk_1.default.bold(str.slice(0, 5).toUpperCase())}
  ${chalk_1.default.italic(str.slice(7))}`),
    usageCommandPlaceholder: str => chalk_1.default.blue(str),
    usagePositionals: str => chalk_1.default.magenta(str),
    usageArgsPlaceholder: str => chalk_1.default.magenta(str),
    usageOptionsPlaceholder: str => chalk_1.default.yellow(str),
    group: (str) => {
        const cleaned = str.endsWith(":") ? str.slice(0, -1) : str;
        return chalk_1.default.bold(cleaned.toUpperCase());
    },
    flags: (str, _type) => {
        const style = str.startsWith("-") ? chalk_1.default.green : chalk_1.default.magenta;
        return style(str);
    },
    hints: str => chalk_1.default.gray(str),
    groupError: str => chalk_1.default.red.bold(str),
    flagsError: str => chalk_1.default.red.bold(str),
    descError: str => chalk_1.default.yellow.bold(str),
    hintsError: str => chalk_1.default.red(str),
    messages: str => chalk_1.default.red.bold(str),
};
// Helper functions
exports.getKeys = (obj) => Object.keys(obj || {});
exports.filterByKeys = (obj, keys) => {
    return keys.reduce((memo, key) => {
        if (obj[key]) {
            memo[key] = obj[key];
        }
        return memo;
    }, {});
};
/**
 * Returns the params that need to be overridden set to false
 */
function falsifyConflictingParams(argv, params) {
    return lodash_1.reduce(argv, (acc, val, key) => {
        const param = params[key];
        const overrides = (param || {}).overrides || [];
        // argv always contains the "_" key which is irrelevant here
        if (key === "_" || !param || !val || !(overrides.length > 0)) {
            return acc;
        }
        const withAliases = overrides.reduce((_, keyToOverride) => {
            if (!params[keyToOverride]) {
                throw new exceptions_1.InternalError(`Cannot override non-existing parameter: ${keyToOverride}`, {
                    keyToOverride,
                    availableKeys: Object.keys(params),
                });
            }
            return [keyToOverride, ...params[keyToOverride].alias];
        }, []);
        withAliases.forEach(keyToOverride => acc[keyToOverride] = false);
        return acc;
    }, {});
}
exports.falsifyConflictingParams = falsifyConflictingParams;
// Sywac specific transformers and helpers
function getOptionSynopsis(key, { alias }) {
    if (alias && alias.length > 1) {
        throw new exceptions_1.InternalError("Option aliases can only be a single character", {
            optionName: key,
            alias,
        });
    }
    return alias ? `-${alias}, --${key}` : `--${key}`;
}
exports.getOptionSynopsis = getOptionSynopsis;
function getArgSynopsis(key, param) {
    return param.required ? `<${key}>` : `[${key}]`;
}
exports.getArgSynopsis = getArgSynopsis;
function prepareArgConfig(param) {
    return {
        desc: param.help,
        params: [prepareOptionConfig(param)],
    };
}
exports.prepareArgConfig = prepareArgConfig;
function prepareOptionConfig(param) {
    const { coerce, defaultValue, help: desc, hints, required, type, } = param;
    if (!VALID_PARAMETER_TYPES.includes(type)) {
        throw new exceptions_1.InternalError(`Invalid parameter type for cli: ${type}`, {
            type,
            validParameterTypes: VALID_PARAMETER_TYPES,
        });
    }
    let config = {
        coerce,
        defaultValue,
        desc,
        required,
        type,
        hints,
        strict: true,
        mustExist: true,
    };
    if (type === "choice") {
        config.type = "enum";
        config.choices = param.choices;
    }
    return config;
}
exports.prepareOptionConfig = prepareOptionConfig;
function failOnInvalidOptions(argv, ctx) {
    const validOptions = lodash_1.flatten(ctx.details.types
        .filter(t => t.datatype !== "command")
        .map(t => t.aliases));
    const receivedOptions = Object.keys(argv);
    const invalid = lodash_1.difference(receivedOptions, validOptions);
    if (invalid.length > 0) {
        ctx.cliMessage(`Received invalid flag(s): ${invalid.join(", ")}`);
    }
}
exports.failOnInvalidOptions = failOnInvalidOptions;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUMsNkJBQTZCLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFBO0tBQ2xFO0FBQ0gsQ0FBQztBQVhELG9EQVdDIiwiZmlsZSI6ImNsaS9oZWxwZXJzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAoQykgMjAxOCBHYXJkZW4gVGVjaG5vbG9naWVzLCBJbmMuIDxpbmZvQGdhcmRlbi5pbz5cbiAqXG4gKiBUaGlzIFNvdXJjZSBDb2RlIEZvcm0gaXMgc3ViamVjdCB0byB0aGUgdGVybXMgb2YgdGhlIE1vemlsbGEgUHVibGljXG4gKiBMaWNlbnNlLCB2LiAyLjAuIElmIGEgY29weSBvZiB0aGUgTVBMIHdhcyBub3QgZGlzdHJpYnV0ZWQgd2l0aCB0aGlzXG4gKiBmaWxlLCBZb3UgY2FuIG9idGFpbiBvbmUgYXQgaHR0cDovL21vemlsbGEub3JnL01QTC8yLjAvLlxuICovXG5cbmltcG9ydCBjaGFsayBmcm9tIFwiY2hhbGtcIlxuaW1wb3J0IHsgZGlmZmVyZW5jZSwgZmxhdHRlbiwgcmVkdWNlIH0gZnJvbSBcImxvZGFzaFwiXG5pbXBvcnQge1xuICBDaG9pY2VzUGFyYW1ldGVyLFxuICBQYXJhbWV0ZXJWYWx1ZXMsXG4gIFBhcmFtZXRlcixcbn0gZnJvbSBcIi4uL2NvbW1hbmRzL2Jhc2VcIlxuaW1wb3J0IHtcbiAgSW50ZXJuYWxFcnJvcixcbn0gZnJvbSBcIi4uL2V4Y2VwdGlvbnNcIlxuXG4vLyBQYXJhbWV0ZXIgdHlwZXMgVCB3aGljaCBtYXAgYmV0d2VlbiB0aGUgUGFyYW1ldGVyPFQ+IGNsYXNzIGFuZCB0aGUgU3l3YWMgY2xpIGxpYnJhcnkuXG4vLyBJbiBjYXNlIHdlIGFkZCB0eXBlcyB0aGF0IGFyZW4ndCBzdXBwb3J0ZWQgbmF0aXZlbHkgYnkgU3l3YWMsIHNlZTogaHR0cDovL3N5d2FjLmlvL2RvY3Mvc3luYy1jb25maWcuaHRtbCNjdXN0b21cbmNvbnN0IFZBTElEX1BBUkFNRVRFUl9UWVBFUyA9IFtcImJvb2xlYW5cIiwgXCJudW1iZXJcIiwgXCJjaG9pY2VcIiwgXCJzdHJpbmdcIiwgXCJhcnJheTpzdHJpbmdcIiwgXCJwYXRoXCIsIFwiYXJyYXk6cGF0aFwiXVxuXG5leHBvcnQgY29uc3Qgc3R5bGVDb25maWcgPSB7XG4gIHVzYWdlUHJlZml4OiBzdHIgPT4gKFxuICAgIGBcbiR7Y2hhbGsuYm9sZChzdHIuc2xpY2UoMCwgNSkudG9VcHBlckNhc2UoKSl9XG4gICR7Y2hhbGsuaXRhbGljKHN0ci5zbGljZSg3KSl9YFxuICApLFxuICB1c2FnZUNvbW1hbmRQbGFjZWhvbGRlcjogc3RyID0+IGNoYWxrLmJsdWUoc3RyKSxcbiAgdXNhZ2VQb3NpdGlvbmFsczogc3RyID0+IGNoYWxrLm1hZ2VudGEoc3RyKSxcbiAgdXNhZ2VBcmdzUGxhY2Vob2xkZXI6IHN0ciA9PiBjaGFsay5tYWdlbnRhKHN0ciksXG4gIHVzYWdlT3B0aW9uc1BsYWNlaG9sZGVyOiBzdHIgPT4gY2hhbGsueWVsbG93KHN0ciksXG4gIGdyb3VwOiAoc3RyOiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCBjbGVhbmVkID0gc3RyLmVuZHNXaXRoKFwiOlwiKSA/IHN0ci5zbGljZSgwLCAtMSkgOiBzdHJcbiAgICByZXR1cm4gY2hhbGsuYm9sZChjbGVhbmVkLnRvVXBwZXJDYXNlKCkpXG4gIH0sXG4gIGZsYWdzOiAoc3RyLCBfdHlwZSkgPT4ge1xuICAgIGNvbnN0IHN0eWxlID0gc3RyLnN0YXJ0c1dpdGgoXCItXCIpID8gY2hhbGsuZ3JlZW4gOiBjaGFsay5tYWdlbnRhXG4gICAgcmV0dXJuIHN0eWxlKHN0cilcbiAgfSxcbiAgaGludHM6IHN0ciA9PiBjaGFsay5ncmF5KHN0ciksXG4gIGdyb3VwRXJyb3I6IHN0ciA9PiBjaGFsay5yZWQuYm9sZChzdHIpLFxuICBmbGFnc0Vycm9yOiBzdHIgPT4gY2hhbGsucmVkLmJvbGQoc3RyKSxcbiAgZGVzY0Vycm9yOiBzdHIgPT4gY2hhbGsueWVsbG93LmJvbGQoc3RyKSxcbiAgaGludHNFcnJvcjogc3RyID0+IGNoYWxrLnJlZChzdHIpLFxuICBtZXNzYWdlczogc3RyID0+IGNoYWxrLnJlZC5ib2xkKHN0ciksIC8vIHRoZXNlIGFyZSBlcnJvciBtZXNzYWdlc1xufVxuXG4vLyBIZWxwZXIgZnVuY3Rpb25zXG5leHBvcnQgY29uc3QgZ2V0S2V5cyA9IChvYmopOiBzdHJpbmdbXSA9PiBPYmplY3Qua2V5cyhvYmogfHwge30pXG5leHBvcnQgY29uc3QgZmlsdGVyQnlLZXlzID0gKG9iajogYW55LCBrZXlzOiBzdHJpbmdbXSk6IGFueSA9PiB7XG4gIHJldHVybiBrZXlzLnJlZHVjZSgobWVtbywga2V5KSA9PiB7XG4gICAgaWYgKG9ialtrZXldKSB7XG4gICAgICBtZW1vW2tleV0gPSBvYmpba2V5XVxuICAgIH1cbiAgICByZXR1cm4gbWVtb1xuICB9LCB7fSlcbn1cblxuZXhwb3J0IHR5cGUgRmFsc2lmaWVkUGFyYW1zID0geyBba2V5OiBzdHJpbmddOiBmYWxzZSB9XG5cbi8qKlxuICogUmV0dXJucyB0aGUgcGFyYW1zIHRoYXQgbmVlZCB0byBiZSBvdmVycmlkZGVuIHNldCB0byBmYWxzZVxuICovXG5leHBvcnQgZnVuY3Rpb24gZmFsc2lmeUNvbmZsaWN0aW5nUGFyYW1zKGFyZ3YsIHBhcmFtczogUGFyYW1ldGVyVmFsdWVzPGFueT4pOiBGYWxzaWZpZWRQYXJhbXMge1xuICByZXR1cm4gcmVkdWNlKGFyZ3YsIChhY2M6IHt9LCB2YWw6IGFueSwga2V5OiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCBwYXJhbSA9IHBhcmFtc1trZXldXG4gICAgY29uc3Qgb3ZlcnJpZGVzID0gKHBhcmFtIHx8IHt9KS5vdmVycmlkZXMgfHwgW11cbiAgICAvLyBhcmd2IGFsd2F5cyBjb250YWlucyB0aGUgXCJfXCIga2V5IHdoaWNoIGlzIGlycmVsZXZhbnQgaGVyZVxuICAgIGlmIChrZXkgPT09IFwiX1wiIHx8ICFwYXJhbSB8fCAhdmFsIHx8ICEob3ZlcnJpZGVzLmxlbmd0aCA+IDApKSB7XG4gICAgICByZXR1cm4gYWNjXG4gICAgfVxuICAgIGNvbnN0IHdpdGhBbGlhc2VzID0gb3ZlcnJpZGVzLnJlZHVjZSgoXywga2V5VG9PdmVycmlkZTogc3RyaW5nKTogc3RyaW5nW10gPT4ge1xuICAgICAgaWYgKCFwYXJhbXNba2V5VG9PdmVycmlkZV0pIHtcbiAgICAgICAgdGhyb3cgbmV3IEludGVybmFsRXJyb3IoYENhbm5vdCBvdmVycmlkZSBub24tZXhpc3RpbmcgcGFyYW1ldGVyOiAke2tleVRvT3ZlcnJpZGV9YCwge1xuICAgICAgICAgIGtleVRvT3ZlcnJpZGUsXG4gICAgICAgICAgYXZhaWxhYmxlS2V5czogT2JqZWN0LmtleXMocGFyYW1zKSxcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICAgIHJldHVybiBba2V5VG9PdmVycmlkZSwgLi4ucGFyYW1zW2tleVRvT3ZlcnJpZGVdLmFsaWFzXVxuICAgIH0sIFtdKVxuXG4gICAgd2l0aEFsaWFzZXMuZm9yRWFjaChrZXlUb092ZXJyaWRlID0+IGFjY1trZXlUb092ZXJyaWRlXSA9IGZhbHNlKVxuICAgIHJldHVybiBhY2NcbiAgfSwge30pXG59XG5cbi8vIFN5d2FjIHNwZWNpZmljIHRyYW5zZm9ybWVycyBhbmQgaGVscGVyc1xuZXhwb3J0IGZ1bmN0aW9uIGdldE9wdGlvblN5bm9wc2lzKGtleTogc3RyaW5nLCB7IGFsaWFzIH06IFBhcmFtZXRlcjxhbnk+KTogc3RyaW5nIHtcbiAgaWYgKGFsaWFzICYmIGFsaWFzLmxlbmd0aCA+IDEpIHtcbiAgICB0aHJvdyBuZXcgSW50ZXJuYWxFcnJvcihcIk9wdGlvbiBhbGlhc2VzIGNhbiBvbmx5IGJlIGEgc2luZ2xlIGNoYXJhY3RlclwiLCB7XG4gICAgICBvcHRpb25OYW1lOiBrZXksXG4gICAgICBhbGlhcyxcbiAgICB9KVxuICB9XG4gIHJldHVybiBhbGlhcyA/IGAtJHthbGlhc30sIC0tJHtrZXl9YCA6IGAtLSR7a2V5fWBcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEFyZ1N5bm9wc2lzKGtleTogc3RyaW5nLCBwYXJhbTogUGFyYW1ldGVyPGFueT4pIHtcbiAgcmV0dXJuIHBhcmFtLnJlcXVpcmVkID8gYDwke2tleX0+YCA6IGBbJHtrZXl9XWBcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByZXBhcmVBcmdDb25maWcocGFyYW06IFBhcmFtZXRlcjxhbnk+KSB7XG4gIHJldHVybiB7XG4gICAgZGVzYzogcGFyYW0uaGVscCxcbiAgICBwYXJhbXM6IFtwcmVwYXJlT3B0aW9uQ29uZmlnKHBhcmFtKV0sXG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBTeXdhY09wdGlvbkNvbmZpZyB7XG4gIGRlc2M6IHN0cmluZyB8IHN0cmluZ1tdXG4gIHR5cGU6IHN0cmluZ1xuICBkZWZhdWx0VmFsdWU/OiBhbnlcbiAgY29lcmNlPzogRnVuY3Rpb25cbiAgY2hvaWNlcz86IGFueVtdXG4gIHJlcXVpcmVkPzogYm9vbGVhblxuICBoaW50cz86IHN0cmluZ1xuICBzdHJpY3Q6IHRydWVcbiAgbXVzdEV4aXN0OiB0cnVlIC8vIEZvciBwYXJhbWV0ZXJzIG9mIHBhdGggdHlwZVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJlcGFyZU9wdGlvbkNvbmZpZyhwYXJhbTogUGFyYW1ldGVyPGFueT4pOiBTeXdhY09wdGlvbkNvbmZpZyB7XG4gIGNvbnN0IHtcbiAgICBjb2VyY2UsXG4gICAgZGVmYXVsdFZhbHVlLFxuICAgIGhlbHA6IGRlc2MsXG4gICAgaGludHMsXG4gICAgcmVxdWlyZWQsXG4gICAgdHlwZSxcbiAgfSA9IHBhcmFtXG4gIGlmICghVkFMSURfUEFSQU1FVEVSX1RZUEVTLmluY2x1ZGVzKHR5cGUpKSB7XG4gICAgdGhyb3cgbmV3IEludGVybmFsRXJyb3IoYEludmFsaWQgcGFyYW1ldGVyIHR5cGUgZm9yIGNsaTogJHt0eXBlfWAsIHtcbiAgICAgIHR5cGUsXG4gICAgICB2YWxpZFBhcmFtZXRlclR5cGVzOiBWQUxJRF9QQVJBTUVURVJfVFlQRVMsXG4gICAgfSlcbiAgfVxuICBsZXQgY29uZmlnOiBTeXdhY09wdGlvbkNvbmZpZyA9IHtcbiAgICBjb2VyY2UsXG4gICAgZGVmYXVsdFZhbHVlLFxuICAgIGRlc2MsXG4gICAgcmVxdWlyZWQsXG4gICAgdHlwZSxcbiAgICBoaW50cyxcbiAgICBzdHJpY3Q6IHRydWUsXG4gICAgbXVzdEV4aXN0OiB0cnVlLCAvLyBGb3IgcGFyYW1ldGVycyBvZiBwYXRoIHR5cGVcbiAgfVxuICBpZiAodHlwZSA9PT0gXCJjaG9pY2VcIikge1xuICAgIGNvbmZpZy50eXBlID0gXCJlbnVtXCJcbiAgICBjb25maWcuY2hvaWNlcyA9ICg8Q2hvaWNlc1BhcmFtZXRlcj5wYXJhbSkuY2hvaWNlc1xuICB9XG4gIHJldHVybiBjb25maWdcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZhaWxPbkludmFsaWRPcHRpb25zKGFyZ3YsIGN0eCkge1xuICBjb25zdCB2YWxpZE9wdGlvbnMgPSBmbGF0dGVuKFxuICAgIGN0eC5kZXRhaWxzLnR5cGVzXG4gICAgICAuZmlsdGVyKHQgPT4gdC5kYXRhdHlwZSAhPT0gXCJjb21tYW5kXCIpXG4gICAgICAubWFwKHQgPT4gdC5hbGlhc2VzKSxcbiAgKVxuICBjb25zdCByZWNlaXZlZE9wdGlvbnMgPSBPYmplY3Qua2V5cyhhcmd2KVxuICBjb25zdCBpbnZhbGlkID0gZGlmZmVyZW5jZShyZWNlaXZlZE9wdGlvbnMsIHZhbGlkT3B0aW9ucylcbiAgaWYgKGludmFsaWQubGVuZ3RoID4gMCkge1xuICAgIGN0eC5jbGlNZXNzYWdlKGBSZWNlaXZlZCBpbnZhbGlkIGZsYWcocyk6ICR7aW52YWxpZC5qb2luKFwiLCBcIil9YClcbiAgfVxufVxuIl19
