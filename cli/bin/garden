#!/usr/bin/env node


const path = require('path');

process.env.NODE_OPTIONS = "max-old-space-size=4096 max-semi-space-size=64";
process.env.STATIC_DIR = path.join(__dirname, '..', 'static');

const fs = require('fs');
const exec = require('child_process').exec;

const gitDir = path.join(process.env.STATIC_DIR, '.git');

if (!fs.existsSync(gitDir)) {
  exec(`git init ${process.env.STATIC_DIR}`, (error, stdout, stderr) => {
    if (error) {
      console.error(`Error: ${error.message}`);
    }
    if (stderr) {
      console.error(`Stderr: ${stderr}`);
    }
  });
}

if (process.env.GARDEN_ENABLE_PROFILING === "1" || process.env.GARDEN_ENABLE_PROFILING === "true") {
  // Patch require to profile module loading
  const Mod = require("module")
  const { performance } = require("perf_hooks")
  const { basename } = require("path")
  const { getDefaultProfiler } = require("@worldofgeese/core/build/src/util/profiling")

  const req = Mod.prototype.require
  const profiler = getDefaultProfiler()
  const prefix = "require:"

  Mod.prototype.require = function () {
    const start = performance.now()

    // eslint-disable-next-line no-invalid-this
    const mod = req.apply(this, arguments)
    profiler.log("require", start) // Aggregate of all requires

    let moduleName = arguments[0]

    if (moduleName.startsWith("/")) {
      // Absolute path
      const split = moduleName.split("/")
      profiler.log(prefix + split[split.length - 1], start)
    } else {
      profiler.log(prefix + moduleName, start)
      // eslint-disable-next-line no-invalid-this
      profiler.log(prefix + basename(this.filename) + ":" + moduleName, start)
    }

    return mod
  }
}

const { initTracing } = require("@worldofgeese/core/build/src/util/open-telemetry/tracing")
initTracing()

const cli = require("../build/src/cli")

// eslint-disable-next-line @typescript-eslint/no-floating-promises
cli.runCli()
