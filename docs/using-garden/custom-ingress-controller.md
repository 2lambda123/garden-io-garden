# Using a custom ingress controller

In this guide, we'll walk you through setting up a Garden project with a custom ingress controller instead of the default Nginx ingress controller. The project is based on the [`simple-project`](https://github.com/garden-io/garden/tree/v0.9.0-docfix.2/examples/simple-project) example.

For the purposes of this guide, we'll use the [Ambassador API Gateway](https://www.getambassador.io/). In order for Ambassador to work, we need to be able to annotate our Kubernetes Service objects. As we'll see, the [Helm module type](https://docs.garden.io/reference/module-types/helm) let's us do just that.

The plan is as follows:

1. Install the official Ambassador Helm chart.
2. Create a base Helm chart for our services that allows us to inject annotations.
3. Add services that extend the base chart.

With this strategy, we're essentially "wrapping" a container module with a Helm module, which allows us to add any arbitrary Kubernetes configuration to our services. This is a powerful pattern that can be used to configure many other third party services to run with Garden.

To learn more about using Helm charts with Garden, please refer to our [Helm user guide](./using-helm-charts.md).

The code in this guide is from our [custom-ingress-controller](https://github.com/garden-io/garden/tree/v0.9.0-docfix.2/examples/) example project.

## Configuring the project

If you've looked at our other examples, the project configuration should look familiar with the exception of the `setupIngressController` key:

```yaml
project:
  name: custom-ingress-controller
  environments:
    - name: local
      providers:
        - name: local-kubernetes
          setupIngressController: false
```

The `setupIngressController` key is specific to the `local-kubernetes` plugin. Setting it to `false` disables the default Nginx ingress controller.

## Installing Ambassador

To install Ambassador, we simply add a Helm module that references the official [Ambassador Helm chart](https://github.com/helm/charts/tree/master/stable/ambassador). The configuration looks like this, in `ambassador/garden.yml`:

```yaml
module:
  description: Ambassador API Gateway
  type: helm
  name: ambassador
  chart: stable/ambassador
  values:
    service:
      annotations:
        getambassador.io/config: |
          ---
          apiVersion: ambassador/v1
          kind: Module
          name: ambassador
          config:
            service_port: 8080 # Set port since the default ingress already occupies the default port
      http:
        port: 8080 # Set port since the default ingress already occupies the default port
```

We configure Ambassador to listen on port `8080` since the default Nginx ingress controller listens on port `80`.

## Creating a base chart for our services

The base chart is a re-usable Helm chart that allows setting the `annotations` field of a Kubernetes Service object. We can then extend our services, which we'll get to in the next section, with this chart and set the appropriate annotations for each one.

The chart is based on the default template generated by the `helm create` command with some exceptions:

1. We've removed the `templates/ingress.yaml`, since Ambassador handles the ingress for us, and simplified the `service.yaml` and `deployment.yaml` files.

2. We've added the `annotations` key to the `service.yaml` file, so that we can inject the annotations Ambassador expects for our services:

```yaml
# base-chart/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: {{ include "base-chart.fullname" . }}
  annotations:
    {{- toYaml .Values.annotations | nindent 4 }} # Here we've add the annotations key
  ...

# base-chart/values.yaml
...
annotations: {}
...
```

3. We've set the `containerPort` to `8080` in the `deployment.yaml` template since that's the port exposed by Docker for both services (we'll get to them in the next section):

```yaml
apiVersion: apps/v1
kind: Deployment
...
spec:
  replicas: {{ .Values.replicaCount }}
  ...
    spec:
      containers:
        - name: {{ include "base-chart.name" . }}
          ...
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          ...
```

## Adding the services

As noted above, this project is based on the [`simple-project`](https://github.com/garden-io/garden/tree/v0.9.0-docfix.2/examples/simple-project) example. We therefore have a `go-service` and a `node-service` that we need to configure to work with Ambassador.

To be able to inject the annotations, we "wrap" our services with a Helm module. Instead of creating Helm templates for both `go-service` and `node-service`, we simply reference the `base-chart` we created in the last step.

As a result, the code for both services is exactly the same as always, we only need to update the `garden.yml` file. Following is the configuration for the `node-service`.

First we specify the Helm module type:

```yaml
kind: Module
description: Helm chart for node-service
type: helm
name: node-service
base: base-chart
serviceResource:
  containerModule: node-service-image
dependencies:
  - go-service
tests:
  - name: integ
    args: [npm, run, integ]
values:
  name: node-service
  image:
    repository: node-service-image
    tag: ${modules.node-service-image.version}
    containerPort: 8080
  service:
    port: 8080
  annotations:
    getambassador.io/config: |
      ---
      apiVersion: ambassador/v1
      kind:  Mapping
      name:  node-service_mapping
      prefix: /node-service/
      service: node-service:8080
 ```

Notice that we've injected the annotations that Ambassador expects via the `values.annotations` key. This is possible since we've specified `base-chart` as our, well, base chart. In the previous step, we enabled setting the annotations for the `base-chart`. Please see the [Ambassador docs](https://www.getambassador.io/user-guide/getting-started/) for more information on how to annotate your services.

Next, we add the configuration for the container module itself to the same file:

```yaml

---

kind: Module
name: node-service-image
description: node-service container
type: container
tests:
  - name: unit
    args: [npm, test]
```

And that's it for our `node-service`.

For more details on how to use container modules with Helm modules, please refer to our [Helm user guide](./using-helm-charts.md).

Similarly, we configure the `go-service`:

```yaml
kind: Module
description: Helm chart for go-service
type: helm
name: go-service
base: base-chart
serviceResource:
  containerModule: go-service-image
values:
  name: go-service
  image:
    repository: go-service-image
    tag: ${modules.go-service-image.version}
    containerPort: 8080
  annotations:
    getambassador.io/config: |
      ---
      apiVersion: ambassador/v1
      kind:  Mapping
      name:  go-service_mapping
      prefix: /go-service/
      service: go-service:80

---

kind: Module
name: go-service-image
description: go-service container
type: container
```

So to recap, what we've done is:

1. Installed Ambassador via the official Helm chart and configured it to listen on port `8080`.
2. Created a `base-chart` that supports injecting service annotations.
3. Configured our two services in a way that allows us to annotate them via the base chart.

## Running the project

With everything set up, we can now deploy our project with the `deploy` command (assuming you're in the project directory):

```sh
garden deploy
```

To see if everything works, we need to use `curl` instead of the Garden `call` command. Because we're letting Ambassador handle our ingresses, we haven't defined any in our `garden.yml` config files, and therefore the `call` command won't work.

To find the external IP for the Ambassador service, run:

```sh
kubectl get svc ambassador --namespace=custom-ingress-controller
```

It should return something like:

```sh
NAME         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                        AGE
ambassador   LoadBalancer   10.102.14.233   localhost     8080:30634/TCP,443:30614/TCP   120m
```

Now we can call our services with:

```sh
curl localhost:8080/node-service/hello-node
```

(or whatever your IP address is). It should return:

```sh
Hello from Node service!
```

This is just one of the many applications of wrapping modules with re-usable Helm charts.