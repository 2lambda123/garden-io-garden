kind: Build
description: The voting UI
name: web-image
type: container
include: [.]

---
kind: Deploy
description: Frontend service container
type: kubernetes 
name: web
dependencies: [build.web-image]
spec:
  files: 
    - manifests/deployment.yaml
    - manifests/service.yaml
    - manifests/ingress.yaml
  namespace: ${environment.namespace}
  patchResources:
  - name: web
    kind: Deployment
    patch:
      spec:
        replicas: 1
        template:
          spec:
            containers:
              - name: web
                image: ${actions.build.web-image.outputs.deploymentImageId}
                env:
                  - name: HOSTNAME
                    value: web.${var.baseHostname || providers.ephemeral-kubernetes.outputs.default-hostname}
  - name: web
    kind: Ingress
    patch:
      spec:
        rules:
          - host: "web.${var.baseHostname || providers.ephemeral-kubernetes.outputs.default-hostname}"
            http:
              paths:
                - path: /hello-frontend
                  pathType: Prefix
                  backend:
                    service:
                      name: web
                      port:
                        number: 80
                - path: /call-backend
                  pathType: Prefix
                  backend:
                    service:
                      name: web
                      port:
                        number: 80



---
kind: Test
type: container
name: web-integ
dependencies: [deploy.web]
spec:
  image: ${actions.build.web-image.outputs.deploymentImageId}
  command: [npm, run, integ]
---
kind: Test
type: kubernetes-exec
name: web-unit
dependencies: [deploy.web]
spec:
  command: [npm, test]
  resource:
    kind: Deployment
    name: web
    namespace: {environment.defaultNamespace}
